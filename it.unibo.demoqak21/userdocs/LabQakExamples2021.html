<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <!--
<link rel="stylesheet" type="text/css" href="../css/issStyle1.css">
<script type="text/javascript" src="../css/issStyle.js"></script>
-->
<style type="text/css">
body
{
    margin-left:  30px;
    margin-right: 30px;
};

P
{
    font-family: Tahoma;
    font-size: 10pt;
};

a, a:visited, a:active, a:link, a:hover {
    text-decoration: underline;
    color: #545454;
    background-color: transparent;
	font-size: 93%;
}

a:hover {
    background-color: #cccccc;
}


hr {
    clear: both;
    height: 1px;
    color: #242424;
    background-color: transparent;
}

h1, h2, h3 {
    color: #242424;
    clear: left;
    font: 100% Tahoma, Helvetica, Arial, sans-serif;
    margin-bottom: 0.5em;
    padding-top: 0.5em;
	border-radius: 10px;
	padding: 5px;
}

top {
	width: 100%;
}


#i {
    color: #ff1010;
}
tt{
	font-family: "Arial";
    font-size: 90%;
	color: #006600;
}
em{
	font-family: "Arial";
    font-size: 80%;
	font-weight: bold;
	border-style:solid;
	border-color: #abe876;
    color: #1632cc;
}
bc{
	font-family: "Arial";
	font-size: 90%;
	font-weight: bold;
    color: #990000;
	background-color: #fcf8c7;
}
ks{
	font-family: "Arial";
	font-weight: bold;
    color: #0000CD	;
	font-size: 90%;
}
kc{
	font-family: "Arial";
	font-weight: bold;
    color: #008000	;
	font-size: 90%;
}
pre{
	font-family: "Consolas";
	font-size: 85%;
	background-color: #f5f5f5;
	border: 1.5px solid silver;
	padding: 5px;
}
m{
	font-family: "Helvetica";
	line-height: 100%;
 	font-size: 75%;
}
div.body{
	 
    font-size: 18px;
}
k{
    color: #990000;
	font-weight: bold;
	font-size: 90%;
}
h1 {
    font-size: 150%;
    background-color: #b2c0ff;
	padding: 10px;
}

h2 {
    background-color: #9ed8ff;
    font-size: 130%;
}

h3 {
	background-color: #e6ccff;
    font-size: 100%;
}
h4 {
    background-color: #ccffcc;
    font-size: 100%;
	width: 95%;
	border-radius: 5px;
	padding: 2px;
}
h5 {
    background-color: #d5ffb0;
    font-size: 100%;

}
div.req{
	background-color: #d9ffb3;
    font-size: 18px;
	width: 700px;
    border: 3px solid green;
    padding: 15px;
    margin: 10px;
}
div.remark{
	background-color: #E3F2FD;
    border: 1.5px solid #d5f2ed;
    padding: 15px;
    margin: 10px;
	border-radius: 25px;
}
table, th, td {
  border: 1px solid black;
  border-collapse: collapse;
}

ol, ul, li {
  margin: 0;
  margin-left: 10px;
  padding: 0;
  padding-bottom: 5px;
}

table, th, td {
	border: 1px solid black;
}

img {
	border: 1.5px solid #d5f2ed

}

a, a:visited, a:active, a:link, a:hover {
    text-decoration: underline;
    color: #545454;
    background-color: transparent;
}

div.wrapdesc{
	width: 90%;
	margin: auto;
}

div.imagedesc{
	width: 85%;
	margin: auto;
}
</style>
    
<head>
   
<title>LabQakExamples2021</title></head>
    
<body>

<div class="body"> 

<h1>LabIss | Using the QActor (meta)model</h1> 

<h2><a id=""/>Starting</h2>

<pre>
<ol>
<li>Download <a href="https://www.eclipse.org/Xtext/download.html" target="web">Eclipse Xtext</a>  and Install Eclipse plugin for Kotlin.</li>
<li>Set (via <tt>Windws->Preferences</tt>) the Java compiler to version <tt>1.8</tt> and the installed jre to <tt>jre1.8.0_ ... </tt> </li>
<li>Copy in <tt>dropins</tt> the files that constitute the support to the <bc>qak</bc> meta-model: 
<bc>it.unibo.Qactork_1.2.4.jar</bc>, <bc>it.unibo.Qactork.ui_1.2.4.jar</bc>, <bc>it.unibo.Qactork.ide_1.2.4.jar</bc>.
<li>In an empty workspace, create a new project of type <tt>Kotlin project</tt> <!-- (e.g. <tt>it.unibo.eclipse.bls</tt>)-->.</li>
<li>In <tt>src</tt>, create a file with extension <tt>qak</tt></li>
</ol>
</pre>
<p>
At this point, Eclipse should present a window like the following one:
</p>
<center><img src="./img/blsStarting.png" alt="blsStarting" width="30%"></center>
<p>

<h2>Examples</h2>
<center><table style="width:98%">
<tbody>	

<tr>
<td style="width:40%">
<h3 id="demonottodo">demonottodo</h3>
<a href="../models/demonottodo.qakt" target="code">demonottodo.qak</a>.<br/>
<m>A model 'non-model'.<br/><br/>
We must always remember that a qak file should include the (textual) definition of a <bc>model</bc>, 
in order to define structure, interaction and behavior of (logical) architectures of distributed systems.
</m>
</td>
<td>
Since the QAk language aims at capturing the interaction between (distributed) actors, it is not
'computationally completed' and part of the behavior could be sometimes directly expressed in Kotlin.
 But <bc>without overstating</bc> such a possibility.  
</td>
</tr>

<tr>
<td style="width:40%">
<h3 id="demostrange">demostrange</h3>
<a href="../models/demostrange.qakt" target="code">demostrange.qak</a>.<br/>
<m> This example allows us to better understand the behavior of empty-moves 
and the 
<a href="../../it.unibo.qakactor/userdocs/LabQakIntro2021.html#msghandlerules" target="lab">Message handling rules</a>

</m>
</td>
<td>
<center><img src="./img/demostrange.png" alt="demostrange" width="35%" ></center>
 
<m></m>
</td>
</tr>


<tr>
<td style="width:40%">
<h3 id="demo0">demo0</h3>
<a href="../models/demo0.qakt" target="code">demo0.qak</a>.<br/>
<m>This is the example introduced in 
<a href="../../it.unibo.qakactor/userdocs/LabQakIntro2021.html#demo" target="web"" target="code">LabQakExamples2021.html</a>.</m>
<br/>
<m>
If we send the sequence: <tt>msg1, msg1, msg2</tt> and
run with <bc>discardMsg On</bc> or with <bc>discardMsg Off</bc>, we have different results:</m>
	<table style="width:95%">
	<td><pre><kc>//discardMsg On</kc>
demo in s1
demo in s2 since msg1:msg1(1)
demo in s3 since msg2:msg2(1)
demo in s1

	</pre></td>
	<td><pre><kc>//discardMsg Off</kc>
demo in s1
demo in s2 since msg1:msg1(1)
demo in s3 since msg2:msg2(1)
demo in s1
demo in s2 since msg1:msg1(2)</pre></td>
	<tr>
	</tr>
	</table>
</td> 
<td>
<center><img src="./img/demoDSL.png" alt="demoDSL" width="50%" ></center>
</td>
</tr>


<tr>
<td><h4>demo0: activation <k>without</k> MQTT</h4>
<m>
<pre><b>
System demo0 
//mqttBroker "localhost" : 1883 <k>eventTopic "demo0/events"</k>
Dispatch msg1 : msg1(ARG)
Dispatch msg2 : msg2(ARG) 
Event alarm   : alarm( KIND )    
Context ctxdemo0 ip [host="localhost" port=8095]</b>
---------------------------------------------------------------------------
    %%% sysUtil | createTheContext ctxdemo0 FOR host=localhost  
    %%% <ks>CoapResourceCtx ctxdemo0 | created </ks> 
    %%% QakContext |  localhost:8095 INIT 
    %%% <kc>QakContextServer serverctxdemo0 | READY TO RECEIVE TCP CONNS on 8095</kc> 
    %%% <ks>QakContext ctxdemo0 |  serverCoap started on port: 8095</ks>
    %%% QakContext | CREATING THE ACTORS on localhost 
    %%% <ks>CoapResourceCtx ctxdemo0 | addActorResource demo</ks> 
    %%% <ks>CoapResourceCtx ctxdemo0 | addActorResource sender</ks> 
    %%% <ks>CoapResourceCtx ctxdemo0 | addActorResource perceiver</ks> 
    %%% QakContext | createContexts on localhost ENDS 
</pre></m>
</td>
<td>
<h4>demo0: activation with MQTT (<k>mosquitto</k> on <ks>localhost</ks>)</h4>
<m>
<pre>
    %%% sysUtil | context ctxdemo0 WORKS ALSO WITH MQTT mqttAddr=tcp://broker.hivemq.com:1883
    %%% sysUtil | createTheContext ctxdemo0 FOR host=localhost  
    %%% <ks>CoapResourceCtx ctxdemo0 | created</ks>  
    %%% QakContext |  localhost:8095 INIT 
    %%% <kc>QakContextServer serverctxdemo0 | READY TO RECEIVE TCP CONNS on 8095</kc> 
    %%% <ks>QakContext ctxdemo0 |  serverCoap started on port: 8095</ks>
    %%% QakContext | CREATING THE ACTORS on localhost 
%%% MqttUtils demo | connect DONE demo to tcp://localhost:1883 
    %%% <ks>CoapResourceCtx ctxdemo0 | addActorResource demo</ks> 
%%% MqttUtils sender | connect DONE sender to tcp://localhost:1883
    %%% <ks>CoapResourceCtx ctxdemo0 | addActorResource sender</ks> 
%%% MqttUtils perceiver | connect DONE perceiver to tcp://localhost:1883
    %%% <ks>CoapResourceCtx ctxdemo0 | addActorResource perceiver</ks> 
    %%% QakContext | createContexts on localhost ENDS 
</pre></m></td>
</tr>

<tr>
<td>
<h3 id="sentinel">sentinel</h3>
<a href="../models/sentinel.qakt" target="code">sentinel.qak</a><br/>
<m>This is the example introduced in 
<a href="../../it.unibo.qakactor/userdocs/LabQakIntro2021.html#sentinel" target="web"" target="code">LabQakIntro2021.html</a>
and shows guards in transition.
<center><img src="./img/sentinel.png" alt="sentinel" width="50%" ></center>
<pre><k>Event</k>   alarm : alarm(V)

<ks>QActor</ks> sentinel context ctxdemo{
  [# val counter=0 	#]	<kc>//Kotlin code</kc>
  <ks>State s0</ks> initial { println("sentinel | STARTS") } <kc>//QActor action</kc>  		  

  Goto <ks>watch</ks> if <k>"counter==0"</k> else <ks>end</ks> <kc>//guard</kc>

  <ks>State watch</ks>{ println("sentinel | WATCH") }
  <bc>Transition</bc> t0
   <k>whenTime</k> 1000 -> <ks>timeout</ks>                 <em>(0)</em>
   <k>whenEvent</k> <ks>alarm</ks> <k>and [# counter==0 #]</k> -> <ks>handleAlarm</ks> <kc>//guard</kc>

  <ks>State timeout</ks>{
	printCurrentMessage		<kc>//QActor action</kc>
	println("sentinel | TIMEOUT")
	[# counter++ 	#]	 	<kc>//Kotlin code</kc>
  }
  <bc>Goto</bc> <ks>s0</ks>                                 <em>(1)</em>
  <bc>//Transition</bc> t0 whenTime 10  > explore <ks>s0</ks>  <em>(2)</em>
 
  <ks>State handleAlarm</ks>{
	printCurrentMessage
	<k>onMsg</k> ( alarm : alarm(V) ) { <kc>//QActor action</kc>
		println("sentinel | ALARM ${<ks>payloadArg</ks>(0)}")
		delay 1000
	}
  }
  <bc>Goto</bc> <ks>s0</ks>

  <ks>State explore</ks>{ println("sentinel | exploring (quite fast) ...") }
  <bc>Goto</bc> watch                            <em>(3)</em>

  <ks>State end</ks>{ println("sentinel | ENDS") }
 }
</pre>

</td>
<td>
<pre><m>//<kc>An emitter</kc> 
<ks>QActor</ks> sender context ctxdemo{
  State s0 initial { 	 		 
	<k>emit</k> alarm : alarm( fire )
	delay 1200
	<k>emit</k> alarm : alarm( tsunami )
}</m></pre>

<m>
The sentinel actor:
<ul>
<li>waits for an alarm event</li>
<li>ends its job after some time (e.g. 1sec)</li>
<li>handles the alarm with a 1500 msecs-activity</li>
<li>restarts its job, after an event-handling </li>
</ul></m>
<!--
	<table style="width:95%">
	<td><pre><kc>//Output</kc>
sentinel | STARTS
		watcher emits fire
sentinel | WATCH
<m>sentinel in handleAlarm | msg(...<k>alarm(fire)</k>,8)</m>
sentinel | ALARM fire 
sentinel | STARTS
sentinel | WATCH
<m>sentinel in timeout | msg(local_tout_...)</m>
sentinel | TIMEOUT
sentinel | STARTS
sentinel | ENDS
		watcher emits tsunami
	</pre></td>
	<td><pre><kc>//output when no <bc>whenTime</bc> in <tt>(0)</tt></kc>
 sentinel | STARTS
			watcher emits fire
sentinel | WATCH
<m>sentinel in handleAlarm | msg(...<k>alarm(fire)</k>,8)</m>
sentinel | ALARM fire 
sentinel | STARTS
sentinel | WATCH
			watcher emits tsunami
<m>sentinel in handleAlarm | msg(... <k>alarm(tsunami)</k>,9)</m>
sentinel | ALARM tsunami 
sentinel | STARTS
sentinel | WATCH	
<pre>
<tr>
	</tr>
	</table>
-->	
 
<m>To understand how the sentinel perceives alarm events, see  
<a href="../../it.unibo.qakactor/userdocs/LabQakIntro2021.html#msghandlerules" target="lab">Message handling rules</a>
<div class="remark">
Note that, if we  insert <bc>delay 1500</bc> in state <tt>handleAlarm</tt>, eliminate <bc>Goto s0</bc> in <em>(1)</em>
and insert the commented  <bc>Transition t0 whenTime 10  -> explore</bc> <em>(2)</em>,
the second alarm is lost.
</div>

	<table style="width:98%">
	 

	<tr><td style="width:50%"><h4>Case <ks>Goto s0</ks></h4>
   	   The actor specifies an empty move. Thus, in this state it does not declare 
           nothing about events or messages.
           The next <tt>alarm</tt> event (tsunami) is inserted in the actor queue, that will be
           inspected in the state <ks>watch</ks>. Thus it will be perceived
	
	</td>
	<td><h4>Case <ks>Transition t0 whenTime 10->explore</ks> </h4>
	The actor declares no interest for the alarm event in this state.
	If the next <tt>alarm event</tt> (tsunami) arrives before <tt>1,5</tt> sec, it is ignored (lost)
	</td>
	</tr>
	</table>
 


</m>


<h3>Events emitted by 'aliens'</h3>  
<m> 
Comment <bc>whenTime</bc> in <tt>(0)</tt> (or set the time to a high value)) and insert <bc>Goto watch</bc> 
in <em>(3)</em>.<br/><br/>
Examples of 'Aliens' written in Ptyhon3 that emit events are:<br/>

<ul>
<li><a href="../resources/python/tcp_emitter.py" target="code">tcp_emitter.py</a> (that makes use of the TCP on the context port) <br/><br/></li>
<li> <a href="../resources/python/mqtt_emitter.py" target="code">mqtt_emitter.py</a> (that makes use of the MQTT broker
specified by the sentinel). 
</m>

 
</li>
</ul>
<h3>Activation sequence</h3>
<ol>
<li>Activate a local MQTT Broker or select a public one</li>
<li>Activate the <ks>sentinel</ks> system by specifying the selected MQTT Broker </li>
<li>Activate the CoaP observer (Kotlin code) 
<a href="../kotlincode/sentinelCoapObserver.kt" target="code">sentinelCoapObserver.kt</a>
</li>
<li>Activate jupyter notebook and open localhost:8888 file: 
 <a href="mqtt_emitter.ipynb" target="code">mqtt_emitter.ipynb</a> or  
 <a href="tcpEmitter.ipynb" target="code">tcpEmitter.ipynb</a> .
 </li>
<li>Run the python programs the generate alarm-events and look at the <tt>sentinelCoapObserver</tt> </li>
</ol> 
</m>

</td>
</tr>



<tr>
<td>
<h3 id="reqsimple">Request simple</h3>
<a href="../models/demo_req_a.qakt" target="code">demo_req_a.qak</a>
<center><img src="./img/reqreply.png" alt="reqreply" width="60%" ></center>
</td>
<td><m>An example of using request/reply
</m></td>
</tr>


<tr>
<td>
<h3 id="reqask">Request with askfor </h3>
<a href="../models/demo_req_b.qakt" target="code">demo_req_b.qak</a>
<center><img src="./img/reqaskreply.png" alt="reqaskreply" width="60%" ></center>
 
</td>
<td><m>An example of using request/reply with <bc>askFor</bc>.
</m></td>
</tr>
 
<tr>
<td>
<h3 id="prolog">Using Prolog</h3>
<a href="../models/prologusage.qakt" target="code">prologusage.qak</a>
 <br/>
 <m>An example of using Prolog and an user-defined declarative knowledge-base:
<a href="../userKb.pl" target="code">userKb.pl</a>
</m>

</td>
<td><m> The QAk infrastructure makes use of a set of system rules expressed in Prolog:
 <a href="../sysRules.pl" target="code">sysRules.pl</a></m></td>
</tr> 


<tr>
<td>
<h3 id="coap">Actors as CoAP resources</h3>
<a href="../models/coapdemo.qakt" target="code">coapdemo.qak</a>
 <br/>
 <a href="../models/coapdemocaller.qakt" target="code">coapdemocaller.qak</a>
 <br/><br/>
 A CoAP observer written in Kotlin is defined in:
 <a href="../resources/coap/actorQakCoapObserver.kt" target="code">resources/coap/actorQakCoapObserver.kt</a>
 <m>
</m>

</td>
<td><m> An example of another caller written in Kotlin:
 
 <a href="../resources/coap/actorQakCoapClient.kt" target="code">resources/coap/actorQakCoapClient.kt</a>
<br/><br/>
The possibility to write a CoAP caller in Python is still under investigation  
 </m></td>
</tr> 

<tr>
<td>
<h3 id="qastreams">Actors as streams</h3>
<center><img src="./img/demoStreams.png" alt="demoStreams" width="60%"></center>
<a href="../models/streamsdemo.qakt" target="code">streamsdemo.qak</a>
 <br/><br/>
 <i>Actors that work in message-driven way</i>
 <m>
 <ul>
 <li><a href="../resources/rx/sonarSimulator.kt" target="code">sonarSimulator.kt</a>: once activated, exploits a 
  <a href="../../it.unibo.kotlinIntro/userDocs/LabIntroductionToKotlin.html#sequences" target="lab">Suspendable Sequence</a>
 to generate a  sequence of (sonar) data  in the form of <i>qak events</i>: <bc>Event sonarRobot  : sonar(DISTANCE)</bc>
 <br/><br/></li>
 <li><a href="../resources/rx/dataLogger.kt" target="code">dataLogger.kt</a>: when it receives a message from the previous component in the pipe,
shows the message and aftwerwards propagates the message (as it is) to the next  component of the pipe.
  <br/><br/></li>
 <li><a href="../resources/rx/dataCleaner.kt" target="code">dataCleaner.kt</a>: when it receives a message (event <bc>sonarRobot</bc>) from the previous component in the pipe,
propagates to the next component only the events whose <bc>DISTANCE</bc> is within a prefixed interval of values;
  <br/><br/></li>
 <li><a href="../resources/rx/distanceFilter.kt" target="code">distanceFilter.kt</a>;
 when it receives a message (event <bc>sonarRobot</bc>) from the previous component in the pipe,
propagates to the next component a new event (<bc>Event obstacle : obstacle(DISTANCE)</bc>) when  the value of <bc>DISTANCE</bc> i sless than 
a prefixed value;
<br/><br/></li>
 <li><bc>qasink</bc>: is the actor defined in the model <a href="../models/streamsdemo.qakt" target="code">streamsdemo.qak</a>.
 It crreates the pipe and handles the events emitted by <a href="../resources/rx/distanceFilter.kt" target="code">distanceFilter.kt</a>
 </li>
 
 </ul>
</m>  

</td>
<td>
<h3>Coded QAkactors</h3>
<m> 
The model  <a href="../models/streamsdemo.qakt" target="code">streamsdemo.qak</a> defines a system composed by the <bc>qasink</bc>
and a set of actors qualified as <tt>CodedQActor</tt>.
<br/><br/>
A <bc>CodedQActor</bc> is an actor completely written in Kotlin that can be included in the system by specifying its class name.
Its presence is included in the description of the system. In fact, in our case, such a descripiton, wrtiten in
<a href="../streamsdemo.pl" target="code">streamsdemo.pl</a> is:
<pre>
context(ctxstreamsdemo, "localhost",  "TCP", "8045").
 qactor( sonarsimulator, ctxstreamsdemo, "rx.sonarSimulator").
  qactor( datalogger, ctxstreamsdemo, "rx.dataLogger").
  qactor( datacleaner, ctxstreamsdemo, "rx.dataCleaner").
  qactor( distancefilter, ctxstreamsdemo, "rx.distanceFilter").
  qactor( qasink, ctxstreamsdemo, "it.unibo.qasink.Qasink").
</pre>
 
Thus, the <tt>QA-infrastructure</tt> handles a <tt>CodedQActor</tt> as a usual; in particular, it will <bc>'inject'</bc> into it the context
specified by the model. 
<br/>
Note that each <tt>CodedQActor</tt> in this example is defined as a specialized version of 
<a href="../../it.unibo.qakactor/userDocs/LabQakIntro2021.html#ActorBasic" tragte="lab">ActorBasic</a> that has no context at creation time.
  </m></td>
</tr> 

</tbody>	
</table></center>


<h2>Case studies</h2>


<center><table style="width:95%">
<tbody>	
<tr>
<td style="width:70%">
<m>
<k>es0</k>: Design and build a software system (named<em>workshift</em>) that allows to manage a machine according to three turns:

<ol>
<li>in the first turn (in the morning) the machine is able to handle messages (dispatches) of type <tt>m1:m1(V)</tt></li>
<li>in the second turn (in the afternoon) the machine is able to handle messages (dispatches) of type <tt>m2:m2(V)</tt></li>
<li>in the third turn (in the nigth) the machine 'sleeps'</li>
</ol>

Messages of types <tt>m1</tt> and <tt>m2</tt> can be sent by external entities at every time.
</m>

</td>
<td><!-- <a href="../models/workshift.qakt" target="code">workshift.qak</a></td> -->
</tr>

<tr>
<td><m>
Design and build a <tt>ButtonLed</tt> software system (<em>bls</em>) that makes human users able to control a <em>led</em> 
according to different control policies each time a <em>button</em> is pressed:

<ol>
<li><k>es1</k>: Turn on/off the <em>led</em></li>
<li><k>es2</k>-Blink/un-blink the <em>led</em></li>
 
<li><k>es3</k>- Todo<!--Control the <em>led</em> to send  a  maritime signal (e.g. 'passage to the east'
( blank ) blinking at groups of three, every 5 seconds)--> </li> 
</ol>

The system should be a distributed system, in which the Button and the Led run on a <i>different computational supports</i>, e.g. a Conventional PC, a RaspberryPi or Arduino.

 
</m>
</td> 
<td>
<!--See <a href="../../it.unibo.bls20/userdocs/bls2020.html" target="lab">BLS2020: The button-led system</a>

<a href="../models/blses1_onoff.qakt" target="code">blses1_onoff.qak</a><br/> 
<a href="../models/blses2_blink.qakt" target="code">blses2_blink.qak</a> 
<h3>Distributed version</h3>
<a href="../models/blsledonly.qakt" target="code">blsledonly.qak</a><br/>
<a href="../models/blsblink.qakt" target="code">blsblink.qak</a><br/>
-->
<m></m></td>
</tr>

<tr>
<td><m>
<k>es4</k>:Design and build a  software system (named <em>taskdeploy</em>) that makes a teacher able to 
assign a set of <ks>N (N>0)</ks> different tasks to the students, like that we are using now.
</m>
</td> 
<td><!-- <a href="../models/gettaskdeploy.qakt" target="code">gettaskdeploy.qak</a><br/>  -->
<m></m></td>
</tr>

 
</tbody>	
</table></center>


</div>


<div style="background-color:rgba(86, 56, 253, 0.9); width:100%;text-align:center;font-size:small;color:white">
By AN Unibo-DISI    
</div> 
</body>
</html>