
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Componenti per i dispositivi di I/O &#8212; iss22 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="componenti-per-i-dispositivi-di-i-o">
<h1>Componenti per i dispositivi di I/O<a class="headerlink" href="#componenti-per-i-dispositivi-di-i-o" title="Permalink to this headline">¶</a></h1>
<p>Il primo <span class="blue">SPRINT</span> di questo nostro sviluppo bottom-up consiste nel realizzare componenti-base
per i dispositivi di I/O, partendo dalle interfacce introdotte nella analisi.</p>
<section id="dispositivi-reali-e-mock-devicefactory-e-file-di-configurazione">
<h2>Dispositivi reali e Mock, DeviceFactory e file di configurazione<a class="headerlink" href="#dispositivi-reali-e-mock-devicefactory-e-file-di-configurazione" title="Permalink to this headline">¶</a></h2>
<p>Per agevolare la messa a punto di una applicazione, conviene spesso introdurre Mock-objects, cioè
dispositivi simulati che riproducono il comportamento dei dispositivi reali in modo controllato.</p>
<p>Inoltre, per facilitare la costruzione di dispositivi senza dover denotare in modo esplicito le classi
di implementazione, conviene introdurre una <strong>Factory</strong>:</p>
<div class="highlight-java notranslate" id="devicefactory"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DeviceFactory</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">ILed</span> <span class="nf">createLed</span><span class="p">()</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">ISonar</span> <span class="nf">createSonar</span><span class="p">()</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">IRadarGui</span> <span class="nf">createRadarGui</span><span class="p">()</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Ciasun metodo di <code class="docutils literal notranslate"><span class="pre">DeviceFactory</span></code> restitusce una istanza di dispositivo reale o Mock in accordo alle specifiche
contenute in un file di Configurazione (<code class="docutils literal notranslate"><span class="pre">RadarSystemConfig.json</span></code>) che qui ipotizziamo scritto in JSon:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="s">&quot;simulation&quot;</span>       <span class="p">:</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
 <span class="p">...</span>
<span class="s">&quot;DLIMIT&quot;</span>           <span class="p">:</span> <span class="s">&quot;15&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Si noti che questo file contiene anche la specifica di <code class="docutils literal notranslate"><span class="pre">DLIMIT</span></code> come richiesto in fase di analisi dei requisiti.</p>
<p>Questo file di configurazione viene letto dal metodo <em>setTheConfiguration</em> di un singleton Java <code class="docutils literal notranslate"><span class="pre">RadarSystemConfig</span></code>
che inizializza variabili <code class="docutils literal notranslate"><span class="pre">static</span></code> accessibili all’applicazione:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RadarSystemConfig</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">simulation</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>  <span class="c1">//overridden by setTheConfiguration</span>
  <span class="p">...</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setTheConfiguration</span><span class="p">(</span> <span class="n">String</span> <span class="n">resourceName</span> <span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">fis</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="p">(</span><span class="k">new</span> <span class="n">File</span><span class="p">(</span><span class="n">resourceName</span><span class="p">));</span>
    <span class="n">JSONTokener</span> <span class="n">tokener</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JSONTokener</span><span class="p">(</span><span class="n">fis</span><span class="p">);</span>
    <span class="n">JSONObject</span> <span class="n">object</span>   <span class="o">=</span> <span class="k">new</span> <span class="n">JSONObject</span><span class="p">(</span><span class="n">tokener</span><span class="p">);</span>
    <span class="n">simulation</span> <span class="o">=</span> <span class="n">object</span><span class="p">.</span><span class="na">getBoolean</span><span class="p">(</span><span class="s">&quot;simulation&quot;</span><span class="p">);</span>
    <span class="p">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Per essere certi che un dispositivo Mock possa essere un sostituto efficace di un dispositivo reale,
introduciamo per ogni dispositivo una <strong>classe astratta</strong> comune alle due tipologie,
che funga anche da Factory specifica per quel tipo di dispositivo.</p>
</section>
<section id="il-led">
<h2>Il Led<a class="headerlink" href="#il-led" title="Permalink to this headline">¶</a></h2>
<p>Un Led è un dispositivo di output che può essere modellato e gestito realizzando i meotdi di
ILed come <em>getter/setter</em> di uno stato interno.</p>
<section id="la-classe-astratta-ledmodel">
<h3>La classe astratta LedModel<a class="headerlink" href="#la-classe-astratta-ledmodel" title="Permalink to this headline">¶</a></h3>
<p>La classe astratta relativa al Led introduce un metodo <span class="blue">abstract</span> denominato <code class="docutils literal notranslate"><span class="pre">ledActivate</span></code>
cui è demandata la responsabilità di accendere/spegnere il Led.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">LedModel</span> <span class="kd">implements</span> <span class="n">ILed</span><span class="p">{</span>
  <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">state</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

  <span class="c1">//Factory methods</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">ILed</span> <span class="nf">create</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">ILed</span> <span class="n">led</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">simulation</span> <span class="p">)</span> <span class="n">led</span> <span class="o">=</span> <span class="n">createLedMock</span><span class="p">();</span>
    <span class="k">else</span> <span class="n">led</span> <span class="o">=</span> <span class="n">createLedConcrete</span><span class="p">();</span>
    <span class="n">led</span><span class="p">.</span><span class="na">turnOff</span><span class="p">();</span>  <span class="c1">//Il led  è inizialmente spento</span>
  <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">ILed</span> <span class="nf">createLedMock</span><span class="p">(){</span><span class="k">return</span> <span class="k">new</span> <span class="n">LedMock</span><span class="p">();</span>  <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">ILed</span> <span class="nf">createLedConcrete</span><span class="p">(){</span><span class="k">return</span> <span class="k">new</span> <span class="n">LedConcrete</span><span class="p">();}</span>

  <span class="c1">//Abstract methods</span>
  <span class="kd">protected</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">ledActivate</span><span class="p">(</span> <span class="kt">boolean</span> <span class="n">val</span><span class="p">);</span>

  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">setState</span><span class="p">(</span> <span class="kt">boolean</span> <span class="n">val</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
    <span class="n">ledActivate</span><span class="p">(</span> <span class="n">state</span> <span class="p">);</span>
  <span class="p">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">turnOn</span><span class="p">(){</span> <span class="n">setState</span><span class="p">(</span> <span class="kc">true</span> <span class="p">);</span> <span class="p">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">turnOff</span><span class="p">()</span> <span class="p">{</span> <span class="n">setState</span><span class="p">(</span> <span class="kc">false</span> <span class="p">);</span> <span class="p">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">getState</span><span class="p">(){</span>  <span class="k">return</span> <span class="n">state</span><span class="p">;</span>  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>La variabile locale booleana <code class="docutils literal notranslate"><span class="pre">state</span></code> viene posta a <code class="docutils literal notranslate"><span class="pre">true</span></code> quando il Led è acceso.</p>
</section>
<section id="il-ledmock">
<h3>Il LedMock<a class="headerlink" href="#il-ledmock" title="Permalink to this headline">¶</a></h3>
<p>In pratica il <code class="docutils literal notranslate"><span class="pre">LedModel</span></code> è già un <code class="docutils literal notranslate"><span class="pre">LedMock</span></code>, in quanto tiene traccia dello stato corrente nella variabile
<code class="docutils literal notranslate"><span class="pre">state</span></code>.</p>
<p>Poichè il metodo <code class="docutils literal notranslate"><span class="pre">ledActivate</span></code> ha la responsabilità di definire il codice specifico per
accedendere/spegenre il Led, a livello di Mock possiamo rendere visibile lo stato del Led
sullo standard output.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LedMock</span> <span class="kd">extends</span> <span class="n">LedModel</span> <span class="kd">implements</span> <span class="n">ILed</span><span class="p">{</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">ledActivate</span><span class="p">(</span><span class="kt">boolean</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>    <span class="n">showState</span><span class="p">();</span> <span class="p">}</span>

  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">showState</span><span class="p">(){</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;LedMock state=&quot;</span> <span class="o">+</span> <span class="n">getState</span><span class="p">()</span> <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Una implementazione più user-friendly potrebbe
introdurre una GUI che cambia di colore e/o dimensione a seconda che il Led sia acceso o spento.
A questo scopo introduciamo anche la classe <code class="docutils literal notranslate"><span class="pre">LedMockWithGui</span></code>.</p>
</section>
<section id="il-ledconcrete">
<h3>Il LedConcrete<a class="headerlink" href="#il-ledconcrete" title="Permalink to this headline">¶</a></h3>
<p>Il componente che realizza la gestione di un Led concreto, conesso a un RaspberryPi, si può avvalere
del software reso disponibile dal committente:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LedConcrete</span> <span class="kd">extends</span> <span class="n">LedModel</span> <span class="kd">implements</span> <span class="n">ILed</span><span class="p">{</span>
<span class="kd">private</span> <span class="n">Runtime</span> <span class="n">rt</span>  <span class="o">=</span> <span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">();</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">ledActivate</span><span class="p">(</span><span class="kt">boolean</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">val</span> <span class="p">)</span> <span class="n">rt</span><span class="p">.</span><span class="na">exec</span><span class="p">(</span> <span class="s">&quot;sudo bash led25GpioTurnOn.sh&quot;</span> <span class="p">);</span>
      <span class="k">else</span> <span class="n">rt</span><span class="p">.</span><span class="na">exec</span><span class="p">(</span> <span class="s">&quot;sudo bash led25GpioTurnOff.sh&quot;</span> <span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="testing-del-dispositivo-led">
<h3>Testing del dispositivo Led<a class="headerlink" href="#testing-del-dispositivo-led" title="Permalink to this headline">¶</a></h3>
<p>Un test automatizzato di tipo unit-testing sul Led può essere espresso usando JUnit come segue:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestLed</span> <span class="p">{</span>
  <span class="nd">@Before</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">up</span><span class="p">(){</span> <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;up&quot;</span><span class="p">);</span> <span class="p">}</span>
  <span class="nd">@After</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">down</span><span class="p">(){</span> <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;down&quot;</span><span class="p">);</span> <span class="p">}</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testLedMock</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">simulation</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="n">ILed</span> <span class="n">led</span> <span class="o">=</span> <span class="n">DeviceFactory</span><span class="p">.</span><span class="na">createLed</span><span class="p">();</span>
    <span class="n">assertTrue</span><span class="p">(</span> <span class="o">!</span> <span class="n">led</span><span class="p">.</span><span class="na">getState</span><span class="p">()</span> <span class="p">);</span>

    <span class="n">led</span><span class="p">.</span><span class="na">turnOn</span><span class="p">();</span>
    <span class="n">assertTrue</span><span class="p">(</span>  <span class="n">led</span><span class="p">.</span><span class="na">getState</span><span class="p">()</span> <span class="p">);</span>
    <span class="n">Utils</span><span class="p">.</span><span class="na">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>                <span class="c1">//to see the ledgui</span>

    <span class="n">led</span><span class="p">.</span><span class="na">turnOff</span><span class="p">();</span>
    <span class="n">assertTrue</span><span class="p">(</span>  <span class="o">!</span> <span class="n">led</span><span class="p">.</span><span class="na">getState</span><span class="p">()</span> <span class="p">);</span>
    <span class="n">Utils</span><span class="p">.</span><span class="na">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>                <span class="c1">//to see the ledgui</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Un test sul <code class="docutils literal notranslate"><span class="pre">LedConcrete</span></code> ha la stessa struttura del test sul <code class="docutils literal notranslate"><span class="pre">LedMock</span></code>, ma bisogna avere l’avvertenza
di eseguirlo sul RaspberryPi. Eseguendo il test sul PC non vengono segnalati errori (in quanto
il Led ‘funziona’ da un punto di vista logico) ma compaiono messaggi del tipo:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LedConcrete</span> <span class="o">|</span> <span class="n">ERROR</span> <span class="n">Cannot</span> <span class="n">run</span> <span class="n">program</span> <span class="s2">&quot;sudo&quot;</span><span class="p">:</span> <span class="o">...</span>
</pre></div>
</div>
</section>
</section>
<section id="il-sonar">
<h2>Il Sonar<a class="headerlink" href="#il-sonar" title="Permalink to this headline">¶</a></h2>
<p>Un Sonar è un dispositivo di input che deve fornire dati quando richiesto dalla applicazione.</p>
<p>Il software fornito dal committente per l’uso di un Sonar reale <code class="docutils literal notranslate"><span class="pre">HC-SR04</span></code> introduce
logicamente un componente attivo, che produce sul dispositivo standard di output,
con una certa frequenza, una sequenza di valori (interi) di distanza.
Nella nostra analisi, invece, il Sonar è un dispositivo produttore di dati di tipo <a href="#id3"><span class="problematic" id="id4">IDistance_</span></a>.</p>
<p>La modellazione di un componente produttore di dati è più complicata di quella di un dispositivo di output
in quanto occorre affrontare un classico problema produttore-consumatore.
Al momento seguiremo un approccio tipico della programmazione concorrente, basato su memoria comune.</p>
<section id="la-classe-astratta-sonarmodel">
<span id="sonarmodel"></span><h3>La classe astratta SonarModel<a class="headerlink" href="#la-classe-astratta-sonarmodel" title="Permalink to this headline">¶</a></h3>
<p>La classe astratta relativa al Sonar introduce due metodi <span class="blue">abstract</span>,  uno per specificare il modo di inizializzare il sonar
(metodo <code class="docutils literal notranslate"><span class="pre">sonarSetUp</span></code>) e uno per specificare il modo di produzione dei dati (metodo <code class="docutils literal notranslate"><span class="pre">sonarProduce</span></code>).
Inoltre, essa definisce due metodi <code class="docutils literal notranslate"><span class="pre">create</span></code> che costituiscono factory-methods per un sonar Mock e un sonar reale.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">SonarModel</span> <span class="kd">implements</span> <span class="n">ISonar</span><span class="p">{</span>
  <span class="kd">protected</span> <span class="kt">boolean</span> <span class="n">stopped</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>    <span class="c1">//quando true, il sonar si ferma</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">queueSize</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="kd">protected</span> <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">IDistance</span><span class="o">&gt;</span> <span class="n">blockingQueue</span> <span class="o">=</span>
          <span class="k">new</span> <span class="n">LinkedBlockingDeque</span><span class="o">&lt;</span><span class="n">IDistance</span><span class="o">&gt;</span><span class="p">(</span><span class="n">queueSize</span><span class="p">);</span>
  <span class="c1">//Factory methods</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">ISonar</span> <span class="nf">create</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">simulation</span> <span class="p">)</span>  <span class="k">return</span> <span class="n">createSonarMock</span><span class="p">();</span>
    <span class="k">else</span>  <span class="k">return</span> <span class="n">createSonarConcrete</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="kd">protected</span> <span class="nf">SonarModel</span><span class="p">()</span> <span class="p">{</span>  <span class="c1">//hidden costructor, to force setup</span>
    <span class="n">sonarSetUp</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">ISonar</span> <span class="nf">createSonarMock</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="n">SonarMock</span><span class="p">();</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">ISonar</span> <span class="nf">createSonarConcrete</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="n">SonarConcrete</span><span class="p">();</span> <span class="p">}</span>
</pre></div>
</div>
<p>Il Sonar viene modellato come un processo che produce dati su un oggetto di tipo
<code class="docutils literal notranslate"><span class="pre">java.util.concurrent.BlockingQueue</span></code> (bounded) che fornisce anche un valido strumento per
la sincronizzazione con i consumatori.
Il tipo di dato degli elementi della coda potrebbe essere:</p>
<ol class="arabic simple">
<li><p><strong>int</strong>: è il tipo di dato prodotto dal core-code del Sonar;</p></li>
<li><p><strong>String</strong>: è la rappresentazione di un valore non meglio determinato;</p></li>
<li><p><strong>IDistance</strong>: è il tipo di dato prodotto dal Sonar a livello logico.</p></li>
</ol>
<p>Poichè i consumtori si aspettano valori di distanza, siamo qui indotti ad optare per la terza opzione
<strong>IDistance</strong>. Tuttavia, motivi di efficienza potrebbero farci optare per la prima e
motivi di flessibilità e di interoperabilità per la seconda.</p>
<p>Il codice relativo alla produzione dei dati viene incapsulato in un metodo abstract <code class="docutils literal notranslate"><span class="pre">sonarProduce</span></code>
che dovrà essere definito in modo diverso da un <code class="docutils literal notranslate"><span class="pre">SonarMock</span></code> e un <code class="docutils literal notranslate"><span class="pre">SonarConcrete</span></code>, così come il
metodo di inizializzazione <code class="docutils literal notranslate"><span class="pre">sonarSetUp</span></code>:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">//Abstract methods</span>
<span class="kd">protected</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">sonarSetUp</span><span class="p">()</span> <span class="p">;</span>
<span class="kd">protected</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">sonarProduce</span><span class="p">(</span> <span class="p">);</span>
</pre></div>
</div>
<p>Il processo di produzione risulta attivo  quando la variabile locale <code class="docutils literal notranslate"><span class="pre">stopped</span></code> è <code class="docutils literal notranslate"><span class="pre">true</span></code>.
Di qui le seguenti definizioni:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">deactivate</span><span class="p">()</span> <span class="p">{</span> <span class="n">stopped</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isActive</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!</span> <span class="n">stopped</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<p>Con queste premesse, il metodo <code class="docutils literal notranslate"><span class="pre">activate</span></code> deve inizializzare il Sonar
e attivare un Thread interno di produzione di dati:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">activate</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">stopped</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">new</span> <span class="n">Thread</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">while</span><span class="p">(</span> <span class="o">!</span> <span class="n">stopped</span>  <span class="p">)</span> <span class="p">{</span> <span class="n">sonarProduce</span><span class="p">();</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}.</span><span class="na">start</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>La parte applicativa che funge da consumatore dei dati prodotti dal Sonar dovrà invocare il metodo
<code class="docutils literal notranslate"><span class="pre">geDistance</span></code> che viene definito in modo da bloccare il chiamante se il Sonar è in ‘fase di produzione’,
riattivandolo non appena il dato è stato prodotto:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">IDistance</span> <span class="nf">getDistance</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="n">IDistance</span> <span class="n">curVal</span> <span class="o">=</span> <span class="n">blockingQueue</span><span class="p">.</span><span class="na">take</span><span class="p">();</span>
      <span class="k">return</span> <span class="n">curVal</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">...</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="il-sonarmock">
<span id="sonarmock"></span><h3>Il SonarMock<a class="headerlink" href="#il-sonarmock" title="Permalink to this headline">¶</a></h3>
<p>Un Mock-sonar che produce valori di distanza da <code class="docutils literal notranslate"><span class="pre">90</span></code> a <code class="docutils literal notranslate"><span class="pre">0</span></code> può quindi ora essere definito come segue:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SonarMock</span> <span class="kd">extends</span> <span class="n">SonarModel</span> <span class="kd">implements</span> <span class="n">ISonar</span><span class="p">{</span>
<span class="kd">protected</span>  <span class="n">IDistance</span> <span class="n">curVal</span> <span class="p">;</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">sonarSetUp</span><span class="p">(){</span>  <span class="n">curVal</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Distance</span><span class="p">(</span><span class="mi">90</span><span class="p">);</span>  <span class="p">}</span>

  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">updateDistance</span><span class="p">(</span> <span class="kt">int</span> <span class="n">d</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="n">curVal</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Distance</span><span class="p">(</span> <span class="n">d</span> <span class="p">);</span>
      <span class="n">blockingQueue</span><span class="p">.</span><span class="na">put</span><span class="p">(</span> <span class="n">curVal</span> <span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span>       <span class="p">}</span>
  <span class="p">}</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">sonarProduce</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">testing</span> <span class="p">)</span> <span class="p">{</span>
      <span class="n">updateDistance</span><span class="p">(</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">testingDistance</span> <span class="p">);</span>
      <span class="n">stopped</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>  <span class="c1">//one shot</span>
    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
      <span class="n">updateDistance</span><span class="p">(</span> <span class="n">curVal</span><span class="p">.</span><span class="na">getVal</span><span class="p">()</span> <span class="o">-</span> <span class="n">delta</span> <span class="p">);</span>
      <span class="n">stopped</span> <span class="o">=</span> <span class="p">(</span> <span class="n">curVal</span><span class="p">.</span><span class="na">getVal</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">);</span>
      <span class="n">Utils</span><span class="p">.</span><span class="na">delay</span><span class="p">(</span><span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">sonarDelay</span><span class="p">);</span>  <span class="c1">//avoid fast generation</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Si noti che:</p>
<ul class="simple">
<li><p>viene definito un nuovo parametro di configurazione <code class="docutils literal notranslate"><span class="pre">testing</span></code> che, quando <code class="docutils literal notranslate"><span class="pre">true</span></code>,  denota che
il sonar sta lavorando in una fase di testing, per cui produce un solo valore dato dal
parametro <code class="docutils literal notranslate"><span class="pre">testingDistance</span></code>;</p></li>
<li><p>viene definito un nuovo parametro di configurazione <code class="docutils literal notranslate"><span class="pre">sonarDelay</span></code> per un rallentamento
della frequenza di generazione dei dati.</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="s">&quot;simulation&quot;</span>       <span class="p">:</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
 <span class="p">...</span>
<span class="s">&quot;DLIMIT&quot;</span>           <span class="p">:</span> <span class="s">&quot;15&quot;</span><span class="p">,</span>
<span class="s">&quot;testing&quot;</span>          <span class="p">:</span> <span class="s">&quot;false&quot;</span>
<span class="s">&quot;testingDistance&quot;</span>  <span class="p">:</span> <span class="s">&quot;10&quot;</span><span class="p">,</span>
<span class="s">&quot;sonarDelay&quot;</span>       <span class="p">:</span> <span class="s">&quot;100&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>l’oggetto inserito in coda (dal metodo <code class="docutils literal notranslate"><span class="pre">updateDistance</span></code>) è una nuova istanza della classe che
implementa <code class="docutils literal notranslate"><span class="pre">IDistance</span></code>.</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Distance</span> <span class="kd">implements</span> <span class="n">IDistance</span><span class="p">{</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">v</span><span class="p">;</span>
  <span class="kd">public</span> <span class="nf">Distance</span><span class="p">(</span><span class="kt">int</span> <span class="n">d</span><span class="p">)</span> <span class="p">{</span> <span class="n">v</span><span class="o">=</span><span class="n">d</span><span class="p">;</span>       <span class="p">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getVal</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">v</span><span class="p">;</span> <span class="p">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="p">(){</span> <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">v</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="il-sonarconcrete">
<h3>Il SonarConcrete<a class="headerlink" href="#il-sonarconcrete" title="Permalink to this headline">¶</a></h3>
<p>Il componente che realizza la gestione di un Sonar concreto, conesso a un RaspberryPi,
si può avvalere del programma <code class="docutils literal notranslate"><span class="pre">SonarAlone.c</span></code> fornito dal committente.</p>
<p>Per ridurre la frequenza di produzione, la inserzione nella coda
avviene solo dopo ogni  <code class="docutils literal notranslate"><span class="pre">numData</span></code> valori emessi sul dispositivo standard di output.</p>
<div class="highlight-java notranslate" id="sonarconcrete"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SonarConcrete</span> <span class="kd">extends</span> <span class="n">SonarModel</span> <span class="kd">implements</span> <span class="n">ISonar</span><span class="p">{</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">numData</span>           <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">dataCounter</span>       <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kd">private</span>  <span class="n">BufferedReader</span> <span class="n">reader</span> <span class="p">;</span>

<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">sonarSetUp</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">curVal</span><span class="p">.</span><span class="na">setVal</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="n">Process</span> <span class="n">p</span>  <span class="o">=</span> <span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="s">&quot;sudo ./SonarAlone&quot;</span><span class="p">);</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="p">(</span> <span class="k">new</span> <span class="n">InputStreamReader</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">()));</span>
  <span class="p">}</span><span class="k">catch</span><span class="p">(</span> <span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span>  <span class="p">}</span>
<span class="p">}</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">updateDistance</span><span class="p">(</span> <span class="kt">int</span> <span class="n">d</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="n">curVal</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Distance</span><span class="p">(</span> <span class="n">d</span> <span class="p">);</span>
    <span class="n">blockingQueue</span><span class="p">.</span><span class="na">put</span><span class="p">(</span> <span class="n">curVal</span> <span class="p">);</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{...</span>       <span class="p">}</span>
<span class="p">}</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">sonarProduce</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="na">readLine</span><span class="p">();</span>
    <span class="n">dataCounter</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">dataCounter</span> <span class="o">%</span> <span class="n">numData</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span> <span class="c1">//every numData ...</span>
      <span class="n">updateDistance</span><span class="p">(</span> <span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span><span class="k">catch</span><span class="p">(</span> <span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="testing-del-dispositivo-sonar">
<h3>Testing del dispositivo Sonar<a class="headerlink" href="#testing-del-dispositivo-sonar" title="Permalink to this headline">¶</a></h3>
<p>Il testing di un sonar riguarda due aspetti distinti:</p>
<ol class="arabic simple">
<li><p>il test sul corretto funzionamento del dispositivo in quanto tale. Supponendo di porre
di fronte al Sonar un ostacolo a distanza <span class="math notranslate nohighlight">\(D\)</span>, il Sonar deve emettere dati di valore
<span class="math notranslate nohighlight">\(D \pm \epsilon\)</span>.</p></li>
<li><p>il test sul corretto funzionamento del componente software responsabile della trasformazione del dispositivo
in un produttore di dati consumabili da un altro componente.</p></li>
</ol>
<p>Ovviamente qui ci dobbiamo occupare della seconda parte, supponendo che la prima sia soddisfatta. A tal fine
possiamo procedere come segue:</p>
<ul class="simple">
<li><p>per il <em>LedMock</em>, poichè siamo noi a generare la sequenza di valori, possiamo
verificare che un <strong>unico</strong> consumatore riceva dal metodo <code class="docutils literal notranslate"><span class="pre">getDistance</span></code> i valori nella giusta sequenza;</p></li>
<li><p>per il <em>LedConcrete</em>, poniamo uno schermo a distanza prefissata <span class="math notranslate nohighlight">\(D\)</span>  e verifichiamo che
un consumatore riceva dal  metodo <code class="docutils literal notranslate"><span class="pre">getDistance</span></code> valori <span class="math notranslate nohighlight">\(D \pm \epsilon\)</span>.</p></li>
</ul>
<p>Un processo consumatore di dati emessi dal sonar può essere definito come segue:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">SonarConsumerForTesting</span> <span class="kd">extends</span> <span class="n">Thread</span><span class="p">{</span>
<span class="kd">private</span> <span class="n">ISonar</span> <span class="n">sonar</span><span class="p">;</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">delta</span><span class="p">;</span>
  <span class="kd">public</span> <span class="nf">SonarConsumerForTesting</span><span class="p">(</span> <span class="n">ISonar</span> <span class="n">sonar</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delta</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="na">sonar</span> <span class="o">=</span> <span class="n">sonar</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="na">delta</span> <span class="o">=</span> <span class="n">delta</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">v0</span> <span class="o">=</span> <span class="n">sonar</span><span class="p">.</span><span class="na">getDistance</span><span class="p">().</span><span class="na">getVal</span><span class="p">();</span>
    <span class="k">while</span><span class="p">(</span> <span class="n">sonar</span><span class="p">.</span><span class="na">isActive</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
      <span class="n">IDistance</span> <span class="n">d</span>      <span class="o">=</span> <span class="n">sonar</span><span class="p">.</span><span class="na">getDistance</span><span class="p">();</span>
      <span class="kt">int</span> <span class="n">v</span>            <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="na">getVal</span><span class="p">();</span>
      <span class="kt">int</span> <span class="n">vexpectedMin</span> <span class="o">=</span> <span class="n">v0</span><span class="o">-</span><span class="n">delta</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">vexpectedMax</span> <span class="o">=</span> <span class="n">v0</span><span class="o">+</span><span class="n">delta</span><span class="p">;</span>
      <span class="n">assertTrue</span><span class="p">(</span>  <span class="n">v</span> <span class="o">&lt;=</span> <span class="n">vexpectedMax</span> <span class="o">&amp;&amp;</span> <span class="n">v</span> <span class="o">&gt;=</span> <span class="n">vexpectedMin</span> <span class="p">);</span>
      <span class="n">v0</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Una TestUnit automatizzata per il <code class="docutils literal notranslate"><span class="pre">SonarMock</span></code> può essere quindi definita in JUnit come segue:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSonarMock</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">simulation</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">sonarDelay</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="c1">//quite fast generation...</span>
  <span class="kt">int</span> <span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="n">ISonar</span> <span class="n">sonar</span> <span class="o">=</span> <span class="n">DeviceFactory</span><span class="p">.</span><span class="na">createSonar</span><span class="p">();</span>
  <span class="k">new</span> <span class="n">SonarConsumerForTesting</span><span class="p">(</span> <span class="n">sonar</span><span class="p">,</span> <span class="n">delta</span> <span class="p">).</span><span class="na">start</span><span class="p">();</span>
  <span class="n">sonar</span><span class="p">.</span><span class="na">activate</span><span class="p">();</span>
  <span class="k">while</span><span class="p">(</span> <span class="n">sonar</span><span class="p">.</span><span class="na">isActive</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span> <span class="n">Utils</span><span class="p">.</span><span class="na">delay</span><span class="p">(</span><span class="mi">100</span><span class="p">);}</span>  <span class="c1">//to avoid premature exit</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Una TestUnit per il <code class="docutils literal notranslate"><span class="pre">SonarConcrete</span></code> è simile, una volta fissato il valore <span class="math notranslate nohighlight">\(delta=\epsilon\)</span>
di varianza sulla distanza-base.</p>
</section>
</section>
<section id="il-sonar-osservabile">
<h2>Il Sonar osservabile<a class="headerlink" href="#il-sonar-osservabile" title="Permalink to this headline">¶</a></h2>
<p>Il Sonar sviluppato fino a questo punto è un processo produttore di valori
di distamza resi disponibili dal metodo <code class="docutils literal notranslate"><span class="pre">getDistance</span></code> che nasconde al suo interno una coda per sincronizzare
i processi consumatori con il processo di produzione del  <code class="docutils literal notranslate"><span class="pre">core-code</span> <span class="pre">HC-SR04</span></code>.</p>
<p>La transizione ad un Sonar osservabile può essere affronatata pensando il nuovo dispostivo in due modi:</p>
<ul class="simple">
<li><p>come una risorsa che modifica uno stato interno ad ogni passo di produzione del <em>core-code HC-SR04</em>
e che invia agli observer una notifica sul nuovo stato;</p></li>
<li><p>come ad un processo che aggiorna un oggetto <span class="blue">DistanceMeasured</span> implementato come una
<span class="blue">risorsa osservabile</span>.</p></li>
</ul>
<p>Come nel caso del tipo dei dati della coda, il tipo di dato
notificato agli observer potrebbe essere:</p>
<ul class="simple">
<li><p><strong>int</strong>: è il tipo di dato prodotto dal <em>core-code HC-SR04</em>;</p></li>
<li><p><strong>String</strong>: è la rappresentazione di un valore non meglio determinato;</p></li>
<li><p><strong>IDistance</strong>: è il tipo di dato prodotto dal Sonar a livello logico.</p></li>
</ul>
<p>Poichè gli observer potrebbero essere non locali e scritti in linguaggi diversi da Java, optiamo qui
per notificare dati in forma di <strong>String</strong>, in modo da agevolare l’interoperabilità.</p>
<p>In ogni caso, volendo impostare il Sonar come un dispositivo osservabile,
introduciamo un nuovo contratto, che estende il precedente:</p>
<div class="highlight-java notranslate" id="iobserver"><span id="isonarobservable"></span><div class="highlight"><pre><span></span><span class="kd">interface</span> <span class="nc">ISonarObservable</span>  <span class="kd">extends</span> <span class="n">ISonar</span><span class="p">{</span>
  <span class="kt">void</span> <span class="nf">register</span><span class="p">(</span> <span class="n">IObserver</span> <span class="n">obs</span> <span class="p">);</span>
  <span class="kt">void</span> <span class="nf">unregister</span><span class="p">(</span> <span class="n">IObserver</span> <span class="n">obs</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kd">interface</span> <span class="nc">IObserver</span> <span class="kd">extends</span> <span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Observer</span><span class="p">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="p">(</span> <span class="kt">int</span> <span class="n">value</span> <span class="p">);</span>
  <span class="c1">//From Observer:public void update(Observable o,Object news)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Nel quadro di un programma ad oggetti convenzionale, un <code class="docutils literal notranslate"><span class="pre">ISonarObservable</span></code>  è un <code class="docutils literal notranslate"><span class="pre">ISonar</span></code>
con la capacità di registrare osservatori e di invocare, ad ogni aggiornamento del valore
di distanza, il metodo <code class="docutils literal notranslate"><span class="pre">update</span></code> di tutti gli osservatori registrati.</p>
<section id="la-distanza-come-risorsa-osservabile">
<h3>La distanza come risorsa osservabile<a class="headerlink" href="#la-distanza-come-risorsa-osservabile" title="Permalink to this headline">¶</a></h3>
<p>In questa versione, optiamo per l’idea che il Sonar-observable sia un processo che aggiorna un
nuovo componente del dominio applicativo che implementa l’interfaccia <code class="docutils literal notranslate"><span class="pre">IDistanceMeasured</span></code>:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IDistanceMeasured</span> <span class="kd">extends</span> <span class="n">IDistance</span><span class="p">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setVal</span><span class="p">(</span> <span class="n">IDistance</span> <span class="n">d</span> <span class="p">);</span>
  <span class="kd">public</span> <span class="n">IDistance</span> <span class="nf">getDistance</span><span class="p">(</span>   <span class="p">);</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addObserver</span><span class="p">(</span><span class="n">Observer</span> <span class="n">obs</span><span class="p">);</span>   <span class="c1">//implemented by Observable</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteObserver</span><span class="p">(</span><span class="n">Observer</span> <span class="n">obs</span><span class="p">);</span><span class="c1">//implemented by Observable</span>
<span class="p">}</span>
</pre></div>
</div>
<p>La casse <span class="blue">DistanceMeasured</span> che esprime una <span class="blue">distanza osservabile</span> può essere definita
come segue:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DistanceMeasured</span>
      <span class="kd">extends</span> <span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Observable</span> <span class="kd">implements</span> <span class="n">IDistanceMeasured</span><span class="p">{</span>
<span class="kd">private</span> <span class="n">IDistance</span> <span class="n">d</span><span class="p">;</span>
<span class="kd">public</span> <span class="nf">DistanceMeasured</span><span class="p">()</span> <span class="p">{}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setVal</span><span class="p">(</span> <span class="n">IDistance</span> <span class="n">v</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
    <span class="n">setChanged</span><span class="p">();</span>
    <span class="n">notifyObservers</span><span class="p">(</span> <span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">d</span><span class="p">.</span><span class="na">getVal</span><span class="p">()</span> <span class="p">);</span>
  <span class="p">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">IDistance</span> <span class="nf">getDistance</span><span class="p">(</span>   <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">d</span><span class="p">;</span> <span class="p">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getVal</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">d</span><span class="p">.</span><span class="na">getVal</span><span class="p">();</span> <span class="p">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">+</span> <span class="n">getVal</span><span class="p">();</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="sonarmodelobservable">
<h3>SonarModelObservable<a class="headerlink" href="#sonarmodelobservable" title="Permalink to this headline">¶</a></h3>
<p>Il <code class="docutils literal notranslate"><span class="pre">SonarModelObservable</span></code> viene definito cone una specializzazione del precedente
<a class="reference internal" href="#sonarmodel">SonarModel</a>, che ridefinisce il <code class="docutils literal notranslate"><span class="pre">sonarSetUp</span></code> creando un oggetto di tipo <code class="docutils literal notranslate"><span class="pre">DistanceMeasured</span></code>
e che implementa i metodi di registrazione ridiregendoli alla distanza osservabile.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">SonarModelObservable</span> <span class="kd">extends</span> <span class="n">SonarModel</span> <span class="kd">implements</span> <span class="n">ISonarObservable</span>  <span class="p">{</span>
<span class="kd">protected</span> <span class="n">IDistanceMeasured</span> <span class="n">observableDistance</span>  <span class="p">;</span>

      <span class="nd">@Override</span>
      <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">sonarSetUp</span><span class="p">()</span> <span class="p">{</span>
              <span class="n">observableDistance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DistanceMeasured</span><span class="p">(</span> <span class="p">);</span>
              <span class="n">observableDistance</span><span class="p">.</span><span class="na">setVal</span><span class="p">(</span><span class="n">curVal</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nd">@Override</span>  <span class="c1">//from SonarModel</span>
      <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">updateDistance</span><span class="p">(</span> <span class="kt">int</span> <span class="n">d</span> <span class="p">)</span> <span class="p">{</span>
              <span class="n">observableDistance</span><span class="p">.</span><span class="na">setVal</span><span class="p">(</span> <span class="n">curVal</span> <span class="p">);</span>    <span class="c1">//notifies the observers</span>
              <span class="kd">super</span><span class="p">.</span><span class="na">updateDistance</span><span class="p">(</span><span class="n">d</span><span class="p">);</span> <span class="c1">//pone curVal nella coda per getDistance</span>
      <span class="p">}</span>
      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">register</span><span class="p">(</span><span class="n">IObserver</span> <span class="n">obs</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">observableDistance</span><span class="p">.</span><span class="na">addObserver</span><span class="p">(</span><span class="n">obs</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">unregister</span><span class="p">(</span><span class="n">IObserver</span> <span class="n">obs</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">observableDistance</span><span class="p">.</span><span class="na">deleteObserver</span><span class="p">(</span><span class="n">obs</span><span class="p">);</span>
      <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="sonarmockobservable">
<h3>SonarMockObservable<a class="headerlink" href="#sonarmockobservable" title="Permalink to this headline">¶</a></h3>
<p>Adesso, il SonarMock observable può essere definito ridefinendo il metodo asbstrat
relativo alla produzione dei dati:</p>
<div class="highlight-java notranslate" id="id1"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SonarMockObservable</span> <span class="kd">extends</span> <span class="n">SonarModelObservable</span><span class="p">{</span>
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">sonarProduce</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">testing</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">updateDistance</span><span class="p">(</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">testingDistance</span> <span class="p">);</span>
    <span class="n">stopped</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>  <span class="c1">//one shot</span>
  <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="n">curVal</span><span class="p">.</span><span class="na">getVal</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">updateDistance</span><span class="p">(</span> <span class="n">v</span> <span class="p">);</span>
    <span class="n">stopped</span> <span class="o">=</span> <span class="p">(</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">);</span>
    <span class="n">Utils</span><span class="p">.</span><span class="na">delay</span><span class="p">(</span><span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">sonarDelay</span><span class="p">);</span>  <span class="c1">//avoid fast generation</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="sonarconcreteobservable">
<h3>SonarConcreteObservable<a class="headerlink" href="#sonarconcreteobservable" title="Permalink to this headline">¶</a></h3>
<p>Analogamente, la versione osservabile del <a class="reference internal" href="#sonarconcrete">SonarConcrete</a> si ottiene ridefinendo (in assenza di ereditarietà
multipla) i metodi astratti  di <code class="docutils literal notranslate"><span class="pre">setUp</span></code> e <code class="docutils literal notranslate"><span class="pre">sonarProduce</span></code>, come già fatto in precedenza:</p>
<div class="highlight-java notranslate" id="id2"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SonarConcreteObservable</span> <span class="kd">extends</span> <span class="n">SonarModelObservable</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">numData</span>           <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">dataCounter</span>       <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kd">private</span>  <span class="n">BufferedReader</span> <span class="n">reader</span> <span class="p">;</span>

<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">sonarSetUp</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">super</span><span class="p">.</span><span class="na">sonarSetUp</span><span class="p">();</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="n">Process</span> <span class="n">p</span>  <span class="o">=</span> <span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="s">&quot;sudo ./SonarAlone&quot;</span><span class="p">);</span>
    <span class="n">reader</span>     <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="p">(</span> <span class="k">new</span> <span class="n">InputStreamReader</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">()));</span>
  <span class="p">}</span><span class="k">catch</span><span class="p">(</span> <span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{...</span>   <span class="p">}</span>
<span class="p">}</span>
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">sonarProduce</span><span class="p">(</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="na">readLine</span><span class="p">();</span>
    <span class="n">dataCounter</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">dataCounter</span> <span class="o">%</span> <span class="n">numData</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span> <span class="c1">//every numData ...</span>
      <span class="n">updateDistance</span><span class="p">(</span> <span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span><span class="k">catch</span><span class="p">(</span> <span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{...</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="aggiornamento-di-devicefactory">
<h3>Aggiornamento di DeviceFactory<a class="headerlink" href="#aggiornamento-di-devicefactory" title="Permalink to this headline">¶</a></h3>
<p>La nascita del nuovo tipo di Sonar ci induce a introdurre nuovi metodi in <a class="reference internal" href="#devicefactory">DeviceFactory</a>:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">ISonar</span> <span class="nf">createSonar</span><span class="p">(</span><span class="kt">boolean</span> <span class="n">observable</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">observable</span> <span class="p">)</span> <span class="k">return</span> <span class="n">createSonarObservable</span><span class="p">();</span>
  <span class="k">else</span> <span class="k">return</span> <span class="n">createSonar</span><span class="p">();</span>
  <span class="p">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="n">ISonarObservable</span> <span class="nf">createSonarObservable</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">simulation</span><span class="p">)</span>  <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="n">SonarMockObservable</span><span class="p">();</span>
  <span class="p">}</span><span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="n">SonarConcreteObservable</span><span class="p">();</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="testing-del-sonar-osservabile">
<h3>Testing del Sonar osservabile<a class="headerlink" href="#testing-del-sonar-osservabile" title="Permalink to this headline">¶</a></h3>
<p>Il testing sul <code class="docutils literal notranslate"><span class="pre">SonarMockObservable</span></code> viene qui impostato nel modo che segue:</p>
<ul class="simple">
<li><p>si regola il Sonar in modo che produca un valore costante definito in <code class="docutils literal notranslate"><span class="pre">RadarSystemConfig.testingDistance</span></code></p></li>
<li><p>si introduce (almeno) un observer che controlla che il dato osservato sia quello emesso</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSingleshotSonarObservableMock</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">testing</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="kt">boolean</span> <span class="n">oneShot</span>           <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="n">ISonarObservable</span> <span class="n">sonar</span> <span class="o">=</span> <span class="n">DeviceFactory</span><span class="p">.</span><span class="na">createSonarObservable</span><span class="p">();</span>
  <span class="n">IObserver</span> <span class="n">obs1</span>         <span class="o">=</span> <span class="k">new</span> <span class="n">SonarObserverFortesting</span><span class="p">(</span><span class="s">&quot;obs1&quot;</span><span class="p">,</span><span class="n">oneShot</span><span class="p">)</span> <span class="p">;</span>
  <span class="n">sonar</span><span class="p">.</span><span class="na">register</span><span class="p">(</span> <span class="n">obs1</span> <span class="p">);</span>     <span class="c1">//add then observer</span>
  <span class="n">sonar</span><span class="p">.</span><span class="na">activate</span><span class="p">();</span>
  <span class="n">sonar</span><span class="p">.</span><span class="na">register</span><span class="p">(</span> <span class="k">new</span> <span class="n">SonarObserverFortesting</span><span class="p">(</span><span class="s">&quot;obs2&quot;</span><span class="p">,</span><span class="n">sonar</span><span class="p">,</span><span class="n">oneShot</span><span class="p">)</span> <span class="p">);</span>
  <span class="kt">int</span> <span class="n">v0</span> <span class="o">=</span> <span class="n">sonar</span><span class="p">.</span><span class="na">getDistance</span><span class="p">().</span><span class="na">getVal</span><span class="p">();</span>
              <span class="n">assertTrue</span><span class="p">(</span>  <span class="n">v0</span> <span class="o">==</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">testingDistance</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>L’<em>observer</em> viene impostato in modo da controllare anche dati emessi da un sonar reale
che opera con ostacolo fisso posto davanti ad esso, alla distanza prefissata.</p>
<div class="highlight-java notranslate" id="sonarobserverfortesting"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">SonarObserverFortesting</span> <span class="kd">implements</span> <span class="n">IObserver</span><span class="p">{</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="p">;</span>
<span class="kd">private</span> <span class="kt">boolean</span> <span class="n">oneShot</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">v0</span>          <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">delta</span>       <span class="o">=</span>  <span class="mi">1</span><span class="p">;</span>
<span class="kd">private</span> <span class="n">ISonarObservable</span> <span class="n">sonar</span><span class="p">;</span>

<span class="kd">public</span> <span class="nf">SonarObserverFortesting</span><span class="p">(</span>
        <span class="n">String</span> <span class="n">name</span><span class="p">,</span><span class="n">ISonarObservable</span> <span class="n">sonar</span><span class="p">,</span><span class="kt">boolean</span> <span class="n">oneShot</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="na">name</span>    <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="na">oneShot</span> <span class="o">=</span> <span class="n">oneShot</span><span class="p">;</span>
<span class="p">}</span>
<span class="nd">@Override</span>  <span class="c1">//from java.util.Observer</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="p">(</span><span class="n">Observable</span> <span class="n">source</span><span class="p">,</span> <span class="n">Object</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="na">toString</span><span class="p">()</span> <span class="p">);</span>
<span class="p">}</span>
<span class="nd">@Override</span> <span class="c1">//from IObserver</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="p">(</span><span class="kt">int</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">oneShot</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">assertTrue</span><span class="p">(</span> <span class="n">value</span> <span class="o">==</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">testingDistance</span> <span class="p">);</span>
  <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">v0</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span><span class="c1">//set the first value observed</span>
      <span class="n">v0</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">vs</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">v0</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>        <span class="c1">//set the first value observed</span>
        <span class="n">v0</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">vexpectedMin</span> <span class="o">=</span> <span class="n">v0</span><span class="o">-</span><span class="n">delta</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">vexpectedMax</span> <span class="o">=</span> <span class="n">v0</span><span class="o">+</span><span class="n">delta</span><span class="p">;</span>
        <span class="n">assertTrue</span><span class="p">(</span><span class="n">value</span><span class="o">&lt;=</span><span class="n">vexpectedMax</span> <span class="o">&amp;&amp;</span> <span class="n">value</span><span class="o">&gt;=</span><span class="n">vexpectedMin</span> <span class="p">);</span>
        <span class="n">v0</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">v0</span> <span class="o">==</span> <span class="mi">30</span> <span class="o">&amp;&amp;</span> <span class="n">name</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;obs1&quot;</span><span class="p">))</span> <span class="n">sonar</span><span class="p">.</span><span class="na">unregister</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="p">}</span><span class="c1">//SonarObserverFortesting</span>
</pre></div>
</div>
<p>Si noti che observer di questo tipo vengono di norma eseguiti all’interno del Thread dell’observable che sta operando
per conto di un qualche client.</p>
</section>
</section>
<section id="il-controller">
<span id="controller"></span><h2>Il Controller<a class="headerlink" href="#il-controller" title="Permalink to this headline">¶</a></h2>
<p>Il componente che realizza la logica applicativa può essere definito partendo dal modello introdotto
nella fase di analisi, attivando un Thread che realizza lo schema <em>read-eval-print</em>.
Nel codice che segue realizzeremo ciascun requisito con un componente specifico:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Controller</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">activate</span><span class="p">(</span> <span class="n">ILed</span> <span class="n">led</span><span class="p">,</span> <span class="n">ISonar</span> <span class="n">sonar</span><span class="p">,</span><span class="n">IRadarDisplay</span> <span class="n">radar</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Controller | activate&quot;</span>  <span class="p">);</span>
    <span class="k">new</span> <span class="n">Thread</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="k">while</span><span class="p">(</span> <span class="n">sonar</span><span class="p">.</span><span class="na">isActive</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
            <span class="n">IDistance</span> <span class="n">d</span> <span class="o">=</span> <span class="n">sonar</span><span class="p">.</span><span class="na">getDistance</span><span class="p">();</span>
            <span class="n">RadarGuiUsecase</span><span class="p">.</span><span class="na">doUseCase</span><span class="p">(</span> <span class="n">radar</span><span class="p">,</span><span class="n">d</span>  <span class="p">);</span>
            <span class="n">LedAlarmUsecase</span><span class="p">.</span><span class="na">doUseCase</span><span class="p">(</span> <span class="n">led</span><span class="p">,</span>  <span class="n">d</span>  <span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span>  <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}.</span><span class="na">start</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="ledalarmusecase">
<h3>LedAlarmUsecase<a class="headerlink" href="#ledalarmusecase" title="Permalink to this headline">¶</a></h3>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LedAlarmUsecase</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">doUseCase</span><span class="p">(</span><span class="n">ILed</span> <span class="n">led</span><span class="p">,</span> <span class="n">IDistance</span> <span class="n">d</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">d</span><span class="p">.</span><span class="na">getVal</span><span class="p">()</span> <span class="o">&lt;</span>  <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">DLIMIT</span> <span class="p">)</span> <span class="n">led</span><span class="p">.</span><span class="na">turnOn</span><span class="p">();</span>
      <span class="k">else</span>  <span class="n">led</span><span class="p">.</span><span class="na">turnOff</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="radarguiusecase">
<h3>RadarGuiUsecase<a class="headerlink" href="#radarguiusecase" title="Permalink to this headline">¶</a></h3>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RadarGuiUsecase</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">doUseCase</span><span class="p">(</span> <span class="n">IRadarDisplay</span> <span class="n">radar</span><span class="p">,</span> <span class="n">IDistance</span> <span class="n">d</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">radar</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">d</span><span class="p">.</span><span class="na">getVal</span><span class="p">(),</span> <span class="s">&quot;90&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="il-sistema-simulato-su-pc">
<h2>Il sistema simulato su PC<a class="headerlink" href="#il-sistema-simulato-su-pc" title="Permalink to this headline">¶</a></h2>
<p>Il sistema viene dapprima costruito secondo le specifiche contenute nel file di configurazione e
successivamente attivato facendo partire il Sonar.</p>
<section id="fase-di-setup">
<h3>Fase di setup<a class="headerlink" href="#fase-di-setup" title="Permalink to this headline">¶</a></h3>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RadarSystemMainOnPc</span> <span class="p">{</span>
<span class="kd">private</span> <span class="n">ISonar</span> <span class="n">sonar</span>        <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">private</span> <span class="n">ILed</span> <span class="n">led</span>            <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">private</span> <span class="n">IRadarDisplay</span> <span class="n">radar</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="p">...</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="n">RadarSystemMainOnPc</span> <span class="n">sys</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RadarSystemMainOnPc</span><span class="p">();</span>
    <span class="n">sys</span><span class="p">.</span><span class="na">setup</span><span class="p">(</span> <span class="s">&quot;RadarSystemConfigPcControllerAndGui.json&quot;</span> <span class="p">);</span>
    <span class="n">sys</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
    <span class="n">sys</span><span class="p">.</span><span class="na">activateSonar</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="il-file-di-configurazione">
<h3>Il file di configurazione<a class="headerlink" href="#il-file-di-configurazione" title="Permalink to this headline">¶</a></h3>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="s">&quot;simulation&quot;</span>       <span class="p">:</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
<span class="s">&quot;ControllerRemote&quot;</span> <span class="p">:</span> <span class="s">&quot;false&quot;</span><span class="p">,</span>
<span class="s">&quot;LedRemote&quot;</span>        <span class="p">:</span> <span class="s">&quot;false&quot;</span><span class="p">,</span>
<span class="s">&quot;SonareRemote&quot;</span>     <span class="p">:</span> <span class="s">&quot;false&quot;</span><span class="p">,</span>
<span class="s">&quot;RadarGuieRemote&quot;</span>  <span class="p">:</span> <span class="s">&quot;false&quot;</span><span class="p">,</span>
<span class="s">&quot;pcHostAddr&quot;</span>       <span class="p">:</span> <span class="s">&quot;localhost&quot;</span><span class="p">,</span>
<span class="s">&quot;raspHostAddr&quot;</span>     <span class="p">:</span> <span class="s">&quot;192.168.1.12&quot;</span><span class="p">,</span>
<span class="s">&quot;radarGuiPort&quot;</span>     <span class="p">:</span> <span class="s">&quot;8014&quot;</span><span class="p">,</span>
<span class="s">&quot;ledPort&quot;</span>          <span class="p">:</span> <span class="s">&quot;8010&quot;</span><span class="p">,</span>
<span class="s">&quot;sonarPort&quot;</span>        <span class="p">:</span> <span class="s">&quot;8012&quot;</span><span class="p">,</span>
<span class="s">&quot;controllerPort&quot;</span>   <span class="p">:</span> <span class="s">&quot;8016&quot;</span><span class="p">,</span>
<span class="s">&quot;serverTimeOut&quot;</span>    <span class="p">:</span> <span class="s">&quot;600000&quot;</span><span class="p">,</span>
<span class="s">&quot;applStartdelay&quot;</span>   <span class="p">:</span> <span class="s">&quot;3000&quot;</span><span class="p">,</span>
<span class="s">&quot;sonarDelay&quot;</span>       <span class="p">:</span> <span class="s">&quot;100&quot;</span><span class="p">,</span>
<span class="s">&quot;DLIMIT&quot;</span>           <span class="p">:</span> <span class="s">&quot;15&quot;</span><span class="p">,</span>
<span class="s">&quot;testing&quot;</span>          <span class="p">:</span> <span class="s">&quot;false&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="fase-di-costruzione-del-sistema">
<h3>Fase di costruzione del sistema<a class="headerlink" href="#fase-di-costruzione-del-sistema" title="Permalink to this headline">¶</a></h3>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RadarSystemMainOnPc</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">build</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="c1">//Dispositivi di Input</span>
    <span class="n">sonar</span>  <span class="o">=</span> <span class="n">DeviceFactory</span><span class="p">.</span><span class="na">createSonar</span><span class="p">();</span>
    <span class="c1">//Dispositivi di Output</span>
    <span class="n">led</span>    <span class="o">=</span> <span class="n">DeviceFactory</span><span class="p">.</span><span class="na">createLed</span><span class="p">();</span>
    <span class="n">radar</span>  <span class="o">=</span> <span class="n">DeviceFactory</span><span class="p">.</span><span class="na">createRadarGui</span><span class="p">();</span>
    <span class="c1">//Controller</span>
    <span class="n">Controller</span><span class="p">.</span><span class="na">activate</span><span class="p">(</span><span class="n">led</span><span class="p">,</span> <span class="n">sonar</span><span class="p">,</span> <span class="n">radar</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">activateSonar</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sonar</span> <span class="o">!=</span> <span class="kc">null</span> <span class="p">)</span> <span class="n">sonar</span><span class="p">.</span><span class="na">activate</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Una unità di testing può automatizzare l’esecuzione di questo sistema ed
effettuare controlli sul suo funzionamento.</p>
</section>
<section id="utilita-per-il-testing">
<h3>Utilità per il testing<a class="headerlink" href="#utilita-per-il-testing" title="Permalink to this headline">¶</a></h3>
<p>Inseriamo nel main program  metodi che restitusicono un riferimento ai componenti del sistema:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RadarSystemMainOnPc</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="kd">public</span> <span class="n">ILed</span> <span class="nf">getLed</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">led</span><span class="p">;</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="n">ISonar</span> <span class="nf">getSonar</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">sonar</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="testing-del-sistema-simulato-su-pc">
<h3>Testing del sistema simulato su PC<a class="headerlink" href="#testing-del-sistema-simulato-su-pc" title="Permalink to this headline">¶</a></h3>
<p>La testUnit introduce un metodo di setup per definire i parametri di configurazione
(in modo da non dipendere da files esterni) e per costruire il sistema.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestBehaviorAllOnPc</span> <span class="p">{</span>
<span class="kd">private</span> <span class="n">RadarSystemAllOnPc</span> <span class="n">sys</span><span class="p">;</span>
  <span class="nd">@Before</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;setUp&quot;</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="n">sys</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RadarSystemAllOnPc</span><span class="p">();</span>
      <span class="c1">//Set system configuration (we don&#39;t use RadarSystemConfig.json)</span>
      <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">simulation</span>        <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">testing</span>           <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">ControllerRemote</span>  <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">LedRemote</span>         <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">SonareRemote</span>      <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">RadarGuieRemote</span>   <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">pcHostAddr</span>        <span class="o">=</span> <span class="s">&quot;localhost&quot;</span><span class="p">;</span>
      <span class="n">sys</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fail</span><span class="p">(</span><span class="s">&quot;setup ERROR &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">()</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
</pre></div>
</div>
<p>Come anticipato in fase di analisi dei requisiti, impostiamo un test nel caso in cui
il Sonar produca un valore <code class="docutils literal notranslate"><span class="pre">d&gt;DLIMIT</span></code> e un altro test per il Sonar che produce un valore <code class="docutils literal notranslate"><span class="pre">d&lt;DLIMIT</span></code>.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testFarDistance</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">testingDistance</span> <span class="o">=</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">DLIMIT</span> <span class="o">+</span> <span class="mi">20</span><span class="p">;</span>
  <span class="n">testTheDistance</span><span class="p">(</span> <span class="kc">false</span> <span class="p">);</span>
<span class="p">}</span>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testNearDistance</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">testingDistance</span> <span class="o">=</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">DLIMIT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">testTheDistance</span><span class="p">(</span> <span class="kc">true</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">testTheDistance</span><span class="p">(</span> <span class="kt">boolean</span> <span class="n">ledStateExpected</span> <span class="p">)</span> <span class="p">{</span>
  <span class="n">RadarDisplay</span> <span class="n">radar</span> <span class="o">=</span> <span class="n">RadarDisplay</span><span class="p">.</span><span class="na">getRadarDisplay</span><span class="p">();</span>  <span class="c1">//singleton</span>
  <span class="n">sys</span><span class="p">.</span><span class="na">activateSonar</span><span class="p">();</span>   <span class="c1">//il sonar produce un solo valore</span>
  <span class="k">while</span><span class="p">(</span> <span class="n">sys</span><span class="p">.</span><span class="na">getSonar</span><span class="p">().</span><span class="na">isActive</span><span class="p">()</span> <span class="p">)</span> <span class="n">Utils</span><span class="p">.</span><span class="na">delay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span> <span class="c1">//give time to work</span>
    <span class="n">assertTrue</span><span class="p">(</span>  <span class="n">sys</span><span class="p">.</span><span class="na">getLed</span><span class="p">().</span><span class="na">getState</span><span class="p">()</span> <span class="o">==</span> <span class="n">ledStateExpected</span>
      <span class="o">&amp;&amp;</span> <span class="n">radar</span><span class="p">.</span><span class="na">getCurDistance</span><span class="p">()</span> <span class="o">==</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">testingDistance</span><span class="p">);</span>
  <span class="n">Utils</span><span class="p">.</span><span class="na">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="p">;</span> <span class="c1">//give time to look at the display</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="index.html">
    <img class="logo" src="_static/logo-unibo.gif" alt="Logo"/>
    
    <h1 class="logo logo-name">iss22</h1>
    
  </a>
</p>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Architetture.html">Architetture</a></li>
<li class="toctree-l1"><a class="reference internal" href="AttoriQak.html">Attori qak</a></li>
<li class="toctree-l1"><a class="reference internal" href="RaspberryPi.html">RaspberryPi</a></li>
<li class="toctree-l1"><a class="reference internal" href="RaspberrySoftware.html">RaspberrySoftware</a></li>
<li class="toctree-l1"><a class="reference internal" href="Robots.html">Robots</a></li>
<li class="toctree-l1"><a class="reference internal" href="Applicazioni.html">Applicazioni</a></li>
<li class="toctree-l1"><a class="reference internal" href="RadarGuiCoap.html">RadarGuiCoap</a></li>
<li class="toctree-l1"><a class="reference internal" href="RadarSystem.html">RadarSystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="ContextServer.html">Il concetto di contesto</a></li>
<li class="toctree-l1"><a class="reference internal" href="DaTcpACoAP.html">Da TCP a CoAP</a></li>
<li class="toctree-l1"><a class="reference internal" href="DaTcpACoAP.html#il-radarsystem-basato-su-coap">Il RadarSystem basato su CoAP</a></li>
<li class="toctree-l1"><a class="reference internal" href="WebSockets.html">WebSockets</a></li>
<li class="toctree-l1"><a class="reference internal" href="RadarSystemDeploy.html">Distribuzione del RadarSystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="Access.html">Access</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Antonio Natali.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.4.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/RadarSystemComponenti.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>