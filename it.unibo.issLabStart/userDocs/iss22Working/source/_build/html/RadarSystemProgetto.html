
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Progettazione e sviluppo incrementali &#8212; iss22 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Supporti per TCP (SPRINT1)" href="RadarSystemSupporti.html" />
    <link rel="prev" title="Prodotti al termine della analisi" href="RadarSystemProdottiAnalisi.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="progettazione-e-sviluppo-incrementali">
<h1>Progettazione e sviluppo incrementali<a class="headerlink" href="#progettazione-e-sviluppo-incrementali" title="Permalink to this headline">¶</a></h1>
<p>Iniziamo il nostro progetto affrontando il primo punto del piano di lavoro proposto dall’analisi
(si veda <a class="reference internal" href="RadarSystemProdottiAnalisi.html#pianolavoro"><span class="std std-ref">Piano di lavoro</span></a>).</p>
<ol class="arabic simple">
<li><p>definizione dei componenti software di base legati ai dispositivi di I/O (Sonar, RadarDisplay e Led);</p></li>
</ol>
<p>Usando la terminologia <span class="blue">SCRUM</span>, associamo questo obiettivo al primo <span class="blue">SPRINT</span> dello sviluppo, al termine del  quale
la prevista <span class="blue">Srint Review</span> farà il punto della situazione con il committente e getterà le basi per
il passo successivo, che potrà coincidere o meno con quello pianificato nell’analisi.</p>
<section id="il-primo-sprint-componenti-per-i-dispositivi-di-i-o">
<h2>Il primo SPRINT: Componenti per i dispositivi di I/O<a class="headerlink" href="#il-primo-sprint-componenti-per-i-dispositivi-di-i-o" title="Permalink to this headline">¶</a></h2>
<p>Il primo <span class="blue">SPRINT</span> del nostro sviluppo bottom-up consiste nel realizzare componenti-base
per i dispositivi di I/O, partendo dalle interfacce introdotte nella analisi.</p>
<section id="devicefactory-e-file-di-configurazione">
<h3>DeviceFactory e file di configurazione<a class="headerlink" href="#devicefactory-e-file-di-configurazione" title="Permalink to this headline">¶</a></h3>
<p>Per agevolare la messa a punto di una applicazione, conviene spesso introdurre Mock-objects, cioè
dispositivi simulati che riproducono il comportamento dei dispositivi reali in modo controllato.</p>
<p>Inoltre, per facilitare la costruzione di dispositivi senza dover denotare in modo esplicito le classi
di implementazione, conviene introdurre una <strong>Factory</strong>:</p>
<div class="highlight-java notranslate" id="devicefactory"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DeviceFactory</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">ILed</span> <span class="nf">createLed</span><span class="p">()</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">ISonar</span> <span class="nf">createSonar</span><span class="p">()</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">IRadarGui</span> <span class="nf">createRadarGui</span><span class="p">()</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Ciasun metodo di <code class="docutils literal notranslate"><span class="pre">DeviceFactory</span></code> restitusce una istanza di dispositivo reale o Mock in accordo alle specifiche
contenute in un file di Configurazione (<code class="docutils literal notranslate"><span class="pre">RadarSystemConfig.json</span></code>) che qui ipotizziamo scritto in JSon:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="s2">&quot;simulation&quot;</span>       <span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
 <span class="o">...</span>
<span class="s2">&quot;DLIMIT&quot;</span>           <span class="p">:</span> <span class="s2">&quot;15&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Si noti che questo file contiene anche la specifica di <code class="docutils literal notranslate"><span class="pre">DLIMIT</span></code> come richiesto in fase di analisi dei requisiti.</p>
<p>Questo file di configurazione viene letto dal metodo <em>setTheConfiguration</em> di un singleton <code class="docutils literal notranslate"><span class="pre">RadarSystemConfig</span></code>
che inizializza variabili <code class="docutils literal notranslate"><span class="pre">static</span></code> accessibili all’applicazione:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RadarSystemConfig</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">simulation</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>  <span class="c1">//overridden by setTheConfiguration</span>
  <span class="p">...</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setTheConfiguration</span><span class="p">(</span> <span class="n">String</span> <span class="n">resourceName</span> <span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">fis</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="p">(</span><span class="k">new</span> <span class="n">File</span><span class="p">(</span><span class="n">resourceName</span><span class="p">));</span>
    <span class="n">JSONTokener</span> <span class="n">tokener</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JSONTokener</span><span class="p">(</span><span class="n">fis</span><span class="p">);</span>
    <span class="n">JSONObject</span> <span class="n">object</span>   <span class="o">=</span> <span class="k">new</span> <span class="n">JSONObject</span><span class="p">(</span><span class="n">tokener</span><span class="p">);</span>
    <span class="n">simulation</span> <span class="o">=</span> <span class="n">object</span><span class="p">.</span><span class="na">getBoolean</span><span class="p">(</span><span class="s">&quot;simulation&quot;</span><span class="p">);</span>
    <span class="p">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="la-classe-colorsout">
<h4>La classe <code class="docutils literal notranslate"><span class="pre">ColorsOut</span></code><a class="headerlink" href="#la-classe-colorsout" title="Permalink to this headline">¶</a></h4>
<p>La classe <span class="blue">ColorsOut</span> è una utility per scrivere su standard ouput messaggi colorati.
Il metodo <code class="docutils literal notranslate"><span class="pre">ColorsOut.outerr</span></code> visualizza un messaggio in colore rosso,
mentre <code class="docutils literal notranslate"><span class="pre">ColorsOut.out</span></code> lo fa con il colore blu o con un colore specificato esplicitamente come parametro
quando il paramtero di configurazione</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="s2">&quot;simulation&quot;</span>       <span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
<span class="s2">&quot;tracing&quot;</span>          <span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
 <span class="o">...</span>
 <span class="p">}</span>
</pre></div>
</div>
<p>Per ottenere messaggi colorati in Eclipse, occorre installare il plugin  <em>ANSI-Escape in Console</em>.</p>
</section>
</section>
<section id="dispositivi-reali-e-mock">
<h3>Dispositivi reali e Mock<a class="headerlink" href="#dispositivi-reali-e-mock" title="Permalink to this headline">¶</a></h3>
<p>Per essere certi che un dispositivo Mock possa essere un sostituto efficace di un dispositivo reale,
introduciamo per ogni dispositivo una <strong>classe astratta</strong> comune alle due tipologie,
che funga anche da Factory specifica per quel tipo di dispositivo.</p>
<p>Partiamo ovviamente tenendo conto delle specifiche sulle interfacce introdotte in fase di analisi:
<a class="reference internal" href="RadarSystemProdottiAnalisi.html#modellooggettidominio"><span class="std std-ref">Modello ad oggetti del dominio</span></a>.</p>
<section id="il-led">
<h4>Il Led<a class="headerlink" href="#il-led" title="Permalink to this headline">¶</a></h4>
<p>Un Led è un dispositivo di output che può essere modellato e gestito realizzando i metodi di <code class="docutils literal notranslate"><span class="pre">ILed</span></code>
(vedi <a class="reference internal" href="RadarSystemProdottiAnalisi.html#iled"><span class="std std-ref">Le interfacce ILed e IRadarDisplay</span></a>) come <em>getter/setter</em> di uno stato interno.</p>
<section id="la-classe-astratta-ledmodel">
<h5>La classe astratta LedModel<a class="headerlink" href="#la-classe-astratta-ledmodel" title="Permalink to this headline">¶</a></h5>
<p>La classe astratta relativa al Led introduce un metodo <span class="blue">abstract</span> denominato <code class="docutils literal notranslate"><span class="pre">ledActivate</span></code>
cui è demandata la responsabilità di accendere/spegnere il Led.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">LedModel</span> <span class="kd">implements</span> <span class="n">ILed</span><span class="p">{</span>
  <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">state</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

  <span class="c1">//Factory methods</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">ILed</span> <span class="nf">create</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">ILed</span> <span class="n">led</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">simulation</span> <span class="p">)</span> <span class="n">led</span> <span class="o">=</span> <span class="n">createLedMock</span><span class="p">();</span>
    <span class="k">else</span> <span class="n">led</span> <span class="o">=</span> <span class="n">createLedConcrete</span><span class="p">();</span>
    <span class="n">led</span><span class="p">.</span><span class="na">turnOff</span><span class="p">();</span>  <span class="c1">//Il led  è inizialmente spento</span>
  <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">ILed</span> <span class="nf">createLedMock</span><span class="p">(){</span><span class="k">return</span> <span class="k">new</span> <span class="n">LedMock</span><span class="p">();</span>  <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">ILed</span> <span class="nf">createLedConcrete</span><span class="p">(){</span><span class="k">return</span> <span class="k">new</span> <span class="n">LedConcrete</span><span class="p">();}</span>

  <span class="c1">//Abstract methods</span>
  <span class="kd">protected</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">ledActivate</span><span class="p">(</span> <span class="kt">boolean</span> <span class="n">val</span><span class="p">);</span>

  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">setState</span><span class="p">(</span> <span class="kt">boolean</span> <span class="n">val</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
    <span class="n">ledActivate</span><span class="p">(</span> <span class="n">state</span> <span class="p">);</span>
  <span class="p">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">turnOn</span><span class="p">(){</span> <span class="n">setState</span><span class="p">(</span> <span class="kc">true</span> <span class="p">);</span> <span class="p">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">turnOff</span><span class="p">()</span> <span class="p">{</span> <span class="n">setState</span><span class="p">(</span> <span class="kc">false</span> <span class="p">);</span> <span class="p">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">getState</span><span class="p">(){</span>  <span class="k">return</span> <span class="n">state</span><span class="p">;</span>  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>La variabile locale booleana <code class="docutils literal notranslate"><span class="pre">state</span></code> viene posta a <code class="docutils literal notranslate"><span class="pre">true</span></code> quando il Led è acceso.</p>
</section>
<section id="il-ledmock">
<h5>Il LedMock<a class="headerlink" href="#il-ledmock" title="Permalink to this headline">¶</a></h5>
<p>In pratica il <code class="docutils literal notranslate"><span class="pre">LedModel</span></code> è già un <code class="docutils literal notranslate"><span class="pre">LedMock</span></code>, in quanto tiene traccia dello stato corrente nella variabile
<code class="docutils literal notranslate"><span class="pre">state</span></code>.</p>
<p>Poichè il metodo <code class="docutils literal notranslate"><span class="pre">ledActivate</span></code> ha la responsabilità di definire il codice specifico per
accedendere/spegenre il Led, a livello di Mock possiamo rendere visibile lo stato del Led
sullo standard output.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LedMock</span> <span class="kd">extends</span> <span class="n">LedModel</span> <span class="kd">implements</span> <span class="n">ILed</span><span class="p">{</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">ledActivate</span><span class="p">(</span><span class="kt">boolean</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>    <span class="n">showState</span><span class="p">();</span> <span class="p">}</span>

  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">showState</span><span class="p">(){</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;LedMock state=&quot;</span> <span class="o">+</span> <span class="n">getState</span><span class="p">()</span> <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Una implementazione più user-friendly potrebbe
introdurre una GUI che cambia di colore e/o dimensione a seconda che il Led sia acceso o spento.
A questo scopo introduciamo anche la classe <code class="docutils literal notranslate"><span class="pre">LedMockWithGui</span></code>.</p>
</section>
<section id="il-ledconcrete">
<h5>Il LedConcrete<a class="headerlink" href="#il-ledconcrete" title="Permalink to this headline">¶</a></h5>
<p>Il componente che realizza la gestione di un Led concreto, conesso a un RaspberryPi, si può avvalere
del software reso disponibile dal committente:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LedConcrete</span> <span class="kd">extends</span> <span class="n">LedModel</span> <span class="kd">implements</span> <span class="n">ILed</span><span class="p">{</span>
<span class="kd">private</span> <span class="n">Runtime</span> <span class="n">rt</span>  <span class="o">=</span> <span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">();</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">ledActivate</span><span class="p">(</span><span class="kt">boolean</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">val</span> <span class="p">)</span> <span class="n">rt</span><span class="p">.</span><span class="na">exec</span><span class="p">(</span> <span class="s">&quot;sudo bash led25GpioTurnOn.sh&quot;</span> <span class="p">);</span>
      <span class="k">else</span> <span class="n">rt</span><span class="p">.</span><span class="na">exec</span><span class="p">(</span> <span class="s">&quot;sudo bash led25GpioTurnOff.sh&quot;</span> <span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="testing-del-dispositivo-led">
<h5>Testing del dispositivo Led<a class="headerlink" href="#testing-del-dispositivo-led" title="Permalink to this headline">¶</a></h5>
<p>Un test automatizzato di tipo unit-testing sul Led può essere espresso usando JUnit come segue:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestLed</span> <span class="p">{</span>
  <span class="nd">@Before</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">up</span><span class="p">(){</span> <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;up&quot;</span><span class="p">);</span> <span class="p">}</span>
  <span class="nd">@After</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">down</span><span class="p">(){</span> <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;down&quot;</span><span class="p">);</span> <span class="p">}</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testLedMock</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">simulation</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="n">ILed</span> <span class="n">led</span> <span class="o">=</span> <span class="n">DeviceFactory</span><span class="p">.</span><span class="na">createLed</span><span class="p">();</span>
    <span class="n">assertTrue</span><span class="p">(</span> <span class="o">!</span> <span class="n">led</span><span class="p">.</span><span class="na">getState</span><span class="p">()</span> <span class="p">);</span>

    <span class="n">led</span><span class="p">.</span><span class="na">turnOn</span><span class="p">();</span>
    <span class="n">assertTrue</span><span class="p">(</span>  <span class="n">led</span><span class="p">.</span><span class="na">getState</span><span class="p">()</span> <span class="p">);</span>
    <span class="n">Utils</span><span class="p">.</span><span class="na">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>                <span class="c1">//to see the ledgui</span>

    <span class="n">led</span><span class="p">.</span><span class="na">turnOff</span><span class="p">();</span>
    <span class="n">assertTrue</span><span class="p">(</span>  <span class="o">!</span> <span class="n">led</span><span class="p">.</span><span class="na">getState</span><span class="p">()</span> <span class="p">);</span>
    <span class="n">Utils</span><span class="p">.</span><span class="na">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>                <span class="c1">//to see the ledgui</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Un test sul <code class="docutils literal notranslate"><span class="pre">LedConcrete</span></code> ha la stessa struttura del test sul <code class="docutils literal notranslate"><span class="pre">LedMock</span></code>, ma bisogna avere l’avvertenza
di eseguirlo sul RaspberryPi. Eseguendo il test sul PC non vengono segnalati errori (in quanto
il Led ‘funziona’ da un punto di vista logico) ma compaiono messaggi del tipo:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LedConcrete</span> <span class="o">|</span> <span class="n">ERROR</span> <span class="n">Cannot</span> <span class="n">run</span> <span class="n">program</span> <span class="s2">&quot;sudo&quot;</span><span class="p">:</span> <span class="o">...</span>
</pre></div>
</div>
</section>
</section>
<section id="il-sonar">
<h4>Il Sonar<a class="headerlink" href="#il-sonar" title="Permalink to this headline">¶</a></h4>
<p>Un Sonar è un dispositivo di input che deve fornire dati, in modo autnomo o quando richiesto dalla applicazione.</p>
<p>Il software fornito dal committente per l’uso di un Sonar reale <code class="docutils literal notranslate"><span class="pre">HC-SR04</span></code> introduce
logicamente un componente attivo, che produce sul dispositivo standard di output,
con una certa frequenza, una sequenza di valori (interi) di distanza.
Nella nostra analisi, invece, il Sonar è un dispositivo produttore di dati di tipo
<code class="docutils literal notranslate"><span class="pre">IDistance</span></code> (si veda:  <a class="reference internal" href="RadarSystemProdottiAnalisi.html#idistance"><span class="std std-ref">Le interfacce IDistance e ISonar</span></a>).</p>
<p>La modellazione di un componente produttore di dati è più complicata di quella di un dispositivo di output
in quanto occorre affrontare un classico problema produttore-consumatore.</p>
<section id="la-classe-astratta-sonarmodel">
<span id="sonarmodel"></span><h5>La classe astratta SonarModel<a class="headerlink" href="#la-classe-astratta-sonarmodel" title="Permalink to this headline">¶</a></h5>
<p>La classe astratta relativa al Sonar introduce due metodi <span class="blue">abstract</span>,  uno per specificare il modo di inizializzare il sonar
(metodo <code class="docutils literal notranslate"><span class="pre">sonarSetUp</span></code>) e uno per specificare il modo di produzione dei dati (metodo <code class="docutils literal notranslate"><span class="pre">sonarProduce</span></code>).
Inoltre, essa definisce due metodi <code class="docutils literal notranslate"><span class="pre">create</span></code> che costituiscono factory-methods per un sonar Mock e un sonar reale.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">SonarModel</span> <span class="kd">implements</span> <span class="n">ISonar</span><span class="p">{</span>
  <span class="kd">protected</span> <span class="kt">boolean</span> <span class="n">stopped</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">//se true il sonar si ferma</span>
  <span class="kd">protected</span>  <span class="n">IDistance</span> <span class="n">curVal</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Distance</span><span class="p">(</span><span class="mi">90</span><span class="p">);</span>
  <span class="c1">//Factory methods</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">ISonar</span> <span class="nf">create</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">simulation</span> <span class="p">)</span>  <span class="k">return</span> <span class="n">createSonarMock</span><span class="p">();</span>
    <span class="k">else</span>  <span class="k">return</span> <span class="n">createSonarConcrete</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="kd">protected</span> <span class="nf">SonarModel</span><span class="p">()</span> <span class="p">{</span> <span class="c1">//hidden costructor, to force setup</span>
    <span class="n">sonarSetUp</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">ISonar</span> <span class="nf">createSonarMock</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="n">SonarMock</span><span class="p">();</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">ISonar</span> <span class="nf">createSonarConcrete</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="n">SonarConcrete</span><span class="p">();</span> <span class="p">}</span>
</pre></div>
</div>
<p>Il Sonar viene modellato come un processo che produce dati di un tipo
che potrebbe essere:</p>
<ol class="arabic simple">
<li><p><strong>int</strong>: è il tipo di dato prodotto dal core-code del Sonar;</p></li>
<li><p><strong>String</strong>: come rappresentazione del valore  ;</p></li>
<li><p><strong>IDistance</strong>: è il tipo di dato prodotto dal Sonar a livello logico.</p></li>
</ol>
<p>Poichè i consumtori si aspettano valori di distanza, siamo qui indotti ad optare per la terza opzione
<code class="docutils literal notranslate"><span class="pre">IDistance</span></code>. Tuttavia, motivi di efficienza potrebbero farci optare per la prima e
motivi di flessibilità e di interoperabilità per la seconda.</p>
</section>
<section id="la-classe-distance">
<h5>La classe Distance<a class="headerlink" href="#la-classe-distance" title="Permalink to this headline">¶</a></h5>
<p>La classe che implementa <code class="docutils literal notranslate"><span class="pre">IDistance</span></code> viene definita come segue:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Distance</span> <span class="kd">implements</span> <span class="n">IDistance</span><span class="p">{</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">v</span><span class="p">;</span>
  <span class="kd">public</span> <span class="nf">Distance</span><span class="p">(</span><span class="kt">int</span> <span class="n">d</span><span class="p">)</span> <span class="p">{</span> <span class="n">v</span><span class="o">=</span><span class="n">d</span><span class="p">;</span>       <span class="p">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getVal</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">v</span><span class="p">;</span> <span class="p">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="p">(){</span> <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">v</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="la-produzione-dei-dati">
<h5>La produzione dei dati<a class="headerlink" href="#la-produzione-dei-dati" title="Permalink to this headline">¶</a></h5>
<p>Il codice relativo alla produzione dei dati viene incapsulato in un metodo abstract <code class="docutils literal notranslate"><span class="pre">sonarProduce</span></code>
che dovrà essere definito in modo diverso da un <code class="docutils literal notranslate"><span class="pre">SonarMock</span></code> e un <code class="docutils literal notranslate"><span class="pre">SonarConcrete</span></code>, così come il
metodo di inizializzazione <code class="docutils literal notranslate"><span class="pre">sonarSetUp</span></code>:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">//Abstract methods</span>
<span class="kd">protected</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">sonarSetUp</span><span class="p">()</span> <span class="p">;</span>
<span class="kd">protected</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">sonarProduce</span><span class="p">(</span> <span class="p">);</span>
</pre></div>
</div>
<p>Il processo di produzione risulta attivo  quando la variabile locale <code class="docutils literal notranslate"><span class="pre">stopped</span></code> è <code class="docutils literal notranslate"><span class="pre">true</span></code>.
Di qui le seguenti definizioni:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">deactivate</span><span class="p">()</span> <span class="p">{</span> <span class="n">stopped</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isActive</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!</span> <span class="n">stopped</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<p>Con queste premesse, il metodo <code class="docutils literal notranslate"><span class="pre">activate</span></code> deve
attivare un Thread interno di produzione di dati:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">activate</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">stopped</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">new</span> <span class="n">Thread</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">while</span><span class="p">(</span> <span class="o">!</span> <span class="n">stopped</span>  <span class="p">)</span> <span class="p">{</span> <span class="n">sonarProduce</span><span class="p">();</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}.</span><span class="na">start</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>La parte applicativa che funge da consumatore dei dati prodotti dal Sonar dovrà invocare il metodo
<code class="docutils literal notranslate"><span class="pre">geDistance</span></code> che viene definito in modo da restituire il valore corrente prodotto da Sonar:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span> <span class="nd">@Override</span>
 <span class="kd">public</span> <span class="n">IDistance</span> <span class="nf">getDistance</span><span class="p">()</span> <span class="p">{</span>
   <span class="k">return</span> <span class="n">curVal</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>La variabile <code class="docutils literal notranslate"><span class="pre">curVal</span></code> dovrebbe essere logicamente protetta da un meccanismo di mutua esclusione.
Tuttavia i dati sono in continuo aggiornamento e l’eventuale lettura di un valore non completamente modificato
non è qui un problema.</p>
</section>
<section id="il-sonarmock">
<span id="sonarmock"></span><h5>Il SonarMock<a class="headerlink" href="#il-sonarmock" title="Permalink to this headline">¶</a></h5>
<p>Un Mock-sonar che produce valori di distanza da <code class="docutils literal notranslate"><span class="pre">90</span></code> a <code class="docutils literal notranslate"><span class="pre">0</span></code> può quindi ora essere definito come segue:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SonarMock</span> <span class="kd">extends</span> <span class="n">SonarModel</span> <span class="kd">implements</span> <span class="n">ISonar</span><span class="p">{</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">sonarSetUp</span><span class="p">(){</span>  <span class="n">curVal</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Distance</span><span class="p">(</span><span class="mi">90</span><span class="p">);</span>  <span class="p">}</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">sonarProduce</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">testing</span> <span class="p">)</span> <span class="p">{</span>
      <span class="n">updateDistance</span><span class="p">(</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">testingDistance</span> <span class="p">);</span>
      <span class="n">stopped</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>  <span class="c1">//one shot</span>
    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="n">curVal</span><span class="p">.</span><span class="na">getVal</span><span class="p">()</span> <span class="o">-</span> <span class="n">delta</span><span class="p">;</span>
      <span class="n">updateDistance</span><span class="p">(</span> <span class="n">v</span> <span class="p">);</span>
      <span class="n">stopped</span> <span class="o">=</span> <span class="p">(</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">);</span>
      <span class="n">Utils</span><span class="p">.</span><span class="na">delay</span><span class="p">(</span><span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">sonarDelay</span><span class="p">);</span> <span class="c1">//avoid fast generation</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Si noti che:</p>
<ul class="simple">
<li><p>viene definito un nuovo parametro di configurazione <code class="docutils literal notranslate"><span class="pre">testing</span></code> che, quando <code class="docutils literal notranslate"><span class="pre">true</span></code>,  denota che
il sonar sta lavorando in una fase di testing, per cui produce un solo valore dato dal
parametro <code class="docutils literal notranslate"><span class="pre">testingDistance</span></code>. Ciò al fine di controllare il Sonar come emettitore di un dato noto.</p></li>
<li><p>viene definito un nuovo parametro di configurazione <code class="docutils literal notranslate"><span class="pre">sonarDelay</span></code> per un rallentamento
della frequenza di generazione dei dati.</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="s">&quot;simulation&quot;</span>       <span class="p">:</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
 <span class="p">...</span>
<span class="s">&quot;DLIMIT&quot;</span>           <span class="p">:</span> <span class="s">&quot;15&quot;</span><span class="p">,</span>
<span class="s">&quot;testing&quot;</span>          <span class="p">:</span> <span class="s">&quot;false&quot;</span>
<span class="s">&quot;testingDistance&quot;</span>  <span class="p">:</span> <span class="s">&quot;10&quot;</span><span class="p">,</span>
<span class="s">&quot;sonarDelay&quot;</span>       <span class="p">:</span> <span class="s">&quot;100&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="il-sonarconcrete">
<h5>Il SonarConcrete<a class="headerlink" href="#il-sonarconcrete" title="Permalink to this headline">¶</a></h5>
<p>Il componente che realizza la gestione di un Sonar concreto, conesso a un RaspberryPi,
si può avvalere del programma <code class="docutils literal notranslate"><span class="pre">SonarAlone.c</span></code> fornito dal committente.</p>
<div class="highlight-java notranslate" id="sonarconcrete"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SonarConcrete</span> <span class="kd">extends</span> <span class="n">SonarModel</span> <span class="kd">implements</span> <span class="n">ISonar</span><span class="p">{</span>
<span class="kd">private</span> <span class="n">Process</span> <span class="n">p</span> <span class="p">;</span>
<span class="kd">private</span>  <span class="n">BufferedReader</span> <span class="n">reader</span> <span class="p">;</span>

<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">sonarSetUp</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">curVal</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Distance</span><span class="p">(</span><span class="mi">90</span><span class="p">);</span>
<span class="p">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">activate</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">p</span> <span class="o">==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="n">p</span> <span class="o">=</span> <span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="s">&quot;sudo ./SonarAlone&quot;</span><span class="p">);</span>
      <span class="n">reader</span>  <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="p">(</span> <span class="k">new</span> <span class="n">InputStreamReader</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">()));</span>
                <span class="p">}</span><span class="k">catch</span><span class="p">(</span> <span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
  <span class="p">}</span>
  <span class="kd">super</span><span class="p">.</span><span class="na">activate</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">sonarProduce</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="na">readLine</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">data</span> <span class="o">==</span> <span class="kc">null</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">lastSonarVal</span> <span class="o">=</span> <span class="n">curVal</span><span class="p">.</span><span class="na">getVal</span><span class="p">();</span>
    <span class="c1">//Eliminiamo dati del tipo 3430</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">lastSonarVal</span> <span class="o">!=</span> <span class="n">v</span> <span class="o">&amp;&amp;</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">sonarDistanceMax</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">updateDistance</span><span class="p">(</span> <span class="n">v</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span><span class="k">catch</span><span class="p">(</span> <span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="p">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">deactivate</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">curVal</span>            <span class="o">=</span> <span class="k">new</span> <span class="n">Distance</span><span class="p">(</span><span class="mi">90</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">p</span><span class="p">.</span><span class="na">destroy</span><span class="p">();</span>
    <span class="n">p</span><span class="o">=</span><span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">super</span><span class="p">.</span><span class="na">deactivate</span><span class="p">();</span>
<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="testing-del-dispositivo-sonar">
<h5>Testing del dispositivo Sonar<a class="headerlink" href="#testing-del-dispositivo-sonar" title="Permalink to this headline">¶</a></h5>
<p>Il testing di un sonar riguarda due aspetti distinti:</p>
<ol class="arabic simple">
<li><p>il test sul corretto funzionamento del dispositivo in quanto tale. Supponendo di porre
di fronte al Sonar un ostacolo a distanza <span class="math notranslate nohighlight">\(D\)</span>, il Sonar deve emettere dati di valore
<span class="math notranslate nohighlight">\(D \pm \epsilon\)</span>.</p></li>
<li><p>il test sul corretto funzionamento del componente software responsabile della trasformazione del dispositivo
in un produttore di dati consumabili da un altro componente.</p></li>
</ol>
<p>Ovviamente qui ci dobbiamo occupare della seconda parte, supponendo che la prima sia soddisfatta. A tal fine
possiamo procedere come segue:</p>
<ul class="simple">
<li><p>per il <em>SonardMock</em>, poichè siamo noi a generare la sequenza di valori, possiamo
verificare che un <strong>unico</strong> consumatore riceva dal metodo <code class="docutils literal notranslate"><span class="pre">getDistance</span></code> i valori nella giusta sequenza;</p></li>
<li><p>per il <em>SonarConcrete</em>, poniamo uno schermo a distanza prefissata <span class="math notranslate nohighlight">\(D\)</span>  e verifichiamo che
un consumatore riceva dal  metodo <code class="docutils literal notranslate"><span class="pre">getDistance</span></code> valori <span class="math notranslate nohighlight">\(D \pm \epsilon\)</span>.</p></li>
</ul>
<p>Un processo consumatore di dati emessi dal sonar può essere definito verificando l’aspettativa
di ricevere dati nell’intervallo di confidenza stabilito:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">SonarConsumerForTesting</span> <span class="kd">extends</span> <span class="n">Thread</span><span class="p">{</span>
<span class="kd">private</span> <span class="n">ISonar</span> <span class="n">sonar</span><span class="p">;</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">delta</span><span class="p">;</span>
  <span class="kd">public</span> <span class="nf">SonarConsumerForTesting</span><span class="p">(</span> <span class="n">ISonar</span> <span class="n">sonar</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delta</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="na">sonar</span> <span class="o">=</span> <span class="n">sonar</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="na">delta</span> <span class="o">=</span> <span class="n">delta</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">v0</span> <span class="o">=</span> <span class="n">sonar</span><span class="p">.</span><span class="na">getDistance</span><span class="p">().</span><span class="na">getVal</span><span class="p">();</span>
    <span class="k">while</span><span class="p">(</span> <span class="n">sonar</span><span class="p">.</span><span class="na">isActive</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
      <span class="n">IDistance</span> <span class="n">d</span>      <span class="o">=</span> <span class="n">sonar</span><span class="p">.</span><span class="na">getDistance</span><span class="p">();</span>
      <span class="kt">int</span> <span class="n">v</span>            <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="na">getVal</span><span class="p">();</span>
      <span class="kt">int</span> <span class="n">vexpectedMin</span> <span class="o">=</span> <span class="n">v0</span><span class="o">-</span><span class="n">delta</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">vexpectedMax</span> <span class="o">=</span> <span class="n">v0</span><span class="o">+</span><span class="n">delta</span><span class="p">;</span>
      <span class="n">assertTrue</span><span class="p">(</span>  <span class="n">v</span> <span class="o">&lt;=</span> <span class="n">vexpectedMax</span> <span class="o">&amp;&amp;</span> <span class="n">v</span> <span class="o">&gt;=</span> <span class="n">vexpectedMin</span> <span class="p">);</span>
      <span class="n">v0</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Una TestUnit automatizzata per il <code class="docutils literal notranslate"><span class="pre">SonarMock</span></code> può essere quindi definita in JUnit come segue:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSonarMock</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">simulation</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">sonarDelay</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="c1">//quite fast generation...</span>
  <span class="kt">int</span> <span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="n">ISonar</span> <span class="n">sonar</span> <span class="o">=</span> <span class="n">DeviceFactory</span><span class="p">.</span><span class="na">createSonar</span><span class="p">();</span>
  <span class="k">new</span> <span class="n">SonarConsumerForTesting</span><span class="p">(</span> <span class="n">sonar</span><span class="p">,</span> <span class="n">delta</span> <span class="p">).</span><span class="na">start</span><span class="p">();</span>
  <span class="n">sonar</span><span class="p">.</span><span class="na">activate</span><span class="p">();</span>
  <span class="k">while</span><span class="p">(</span> <span class="n">sonar</span><span class="p">.</span><span class="na">isActive</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span> <span class="n">Utils</span><span class="p">.</span><span class="na">delay</span><span class="p">(</span><span class="mi">100</span><span class="p">);}</span>  <span class="c1">//to avoid premature exit</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Una TestUnit per il <code class="docutils literal notranslate"><span class="pre">SonarConcrete</span></code> è simile, una volta fissato il valore <span class="math notranslate nohighlight">\(delta=\epsilon\)</span>
di varianza sulla distanza-base.</p>
</section>
</section>
<section id="il-sonar-osservabile">
<span id="sonarosservabile"></span><h4>Il Sonar osservabile<a class="headerlink" href="#il-sonar-osservabile" title="Permalink to this headline">¶</a></h4>
<p>La transizione ad un Sonar osservabile prospettata in <a class="reference internal" href="RadarSystemAnalisi.html#patternobserver"><span class="std std-ref">Il pattern observer</span></a> può essere affrontata pensando il nuovo dispositivo in due modi:</p>
<ul class="simple">
<li><p>come una risorsa che modifica il proprio stato interno ad ogni passo di produzione
e che invia agli observer una notifica sul nuovo stato;</p></li>
<li><p>come ad un processo che aggiorna un oggetto <span class="blue">DistanceMeasured</span> implementato come una
<span class="blue">risorsa osservabile</span>.</p></li>
</ul>
<p>Come nel caso del Sonar non osservabile, il tipo di dato
notificato agli observer potrebbe essere <strong>int</strong>, <strong>String</strong> o <strong>IDistance</strong>.
Poichè gli observer potrebbero essere non locali e scritti in linguaggi diversi da Java, optiamo qui
per notificare dati in forma di <strong>String</strong>, in modo da agevolare l’interoperabilità.</p>
<p>In ogni caso, volendo impostare il Sonar come un dispositivo osservabile,
introduciamo un nuovo contratto, che estende il precedente:</p>
<div class="highlight-java notranslate" id="iobserver"><span id="isonarobservable"></span><div class="highlight"><pre><span></span><span class="kd">interface</span> <span class="nc">ISonarObservable</span>  <span class="kd">extends</span> <span class="n">ISonar</span><span class="p">{</span>
  <span class="kt">void</span> <span class="nf">register</span><span class="p">(</span> <span class="n">IObserver</span> <span class="n">obs</span> <span class="p">);</span>
  <span class="kt">void</span> <span class="nf">unregister</span><span class="p">(</span> <span class="n">IObserver</span> <span class="n">obs</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kd">interface</span> <span class="nc">IObserver</span> <span class="kd">extends</span> <span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Observer</span><span class="p">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="p">(</span> <span class="kt">int</span> <span class="n">value</span> <span class="p">);</span>
  <span class="c1">//From Observer:public void update(Observable o,Object news)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Nel quadro di un programma ad oggetti convenzionale, un <code class="docutils literal notranslate"><span class="pre">ISonarObservable</span></code>  è un <code class="docutils literal notranslate"><span class="pre">ISonar</span></code>
con la capacità di registrare osservatori e di invocare, ad ogni aggiornamento del valore
di distanza, il metodo <code class="docutils literal notranslate"><span class="pre">update</span></code> di tutti gli osservatori registrati.</p>
<section id="la-distanza-come-risorsa-osservabile">
<h5>La distanza come risorsa osservabile<a class="headerlink" href="#la-distanza-come-risorsa-osservabile" title="Permalink to this headline">¶</a></h5>
<p>In questa versione, optiamo per l’idea che il Sonar-observable sia un processo che aggiorna
il valore  di una distanza osservabile (distanza misurata)
che implementa l’interfaccia <code class="docutils literal notranslate"><span class="pre">IDistanceMeasured</span></code>:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IDistanceMeasured</span> <span class="kd">extends</span> <span class="n">IDistance</span><span class="p">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setVal</span><span class="p">(</span> <span class="n">IDistance</span> <span class="n">d</span> <span class="p">);</span>
  <span class="kd">public</span> <span class="n">IDistance</span> <span class="nf">getDistance</span><span class="p">(</span>   <span class="p">);</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addObserver</span><span class="p">(</span><span class="n">Observer</span> <span class="n">obs</span><span class="p">);</span>   <span class="c1">//implemented by Observable</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteObserver</span><span class="p">(</span><span class="n">Observer</span> <span class="n">obs</span><span class="p">);</span><span class="c1">//implemented by Observable</span>
<span class="p">}</span>
</pre></div>
</div>
<p>La casse <span class="blue">DistanceMeasured</span> che realizza il concetto di <span class="blue">distanza misurata osservabile</span> può essere definita
come segue:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DistanceMeasured</span>
      <span class="kd">extends</span> <span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Observable</span> <span class="kd">implements</span> <span class="n">IDistanceMeasured</span><span class="p">{</span>
<span class="kd">private</span> <span class="n">IDistance</span> <span class="n">d</span><span class="p">;</span>
<span class="kd">public</span> <span class="nf">DistanceMeasured</span><span class="p">()</span> <span class="p">{}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setVal</span><span class="p">(</span> <span class="n">IDistance</span> <span class="n">v</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
    <span class="n">setChanged</span><span class="p">();</span> <span class="c1">//IMPORTANT!!</span>
    <span class="n">notifyObservers</span><span class="p">(</span> <span class="n">d</span> <span class="p">);</span>
  <span class="p">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">IDistance</span> <span class="nf">getDistance</span><span class="p">(</span>   <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">d</span><span class="p">;</span> <span class="p">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getVal</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">d</span><span class="p">.</span><span class="na">getVal</span><span class="p">();</span> <span class="p">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">+</span> <span class="n">getVal</span><span class="p">();</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="sonarmodelobservable">
<h5>SonarModelObservable<a class="headerlink" href="#sonarmodelobservable" title="Permalink to this headline">¶</a></h5>
<p>Il <code class="docutils literal notranslate"><span class="pre">SonarModelObservable</span></code> viene definito cone una specializzazione del precedente
<a class="reference internal" href="#sonarmodel">SonarModel</a>, che implementa i metodi di registrazione ridiregendoli alla distanza osservabile.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">SonarModelObservable</span>
        <span class="kd">extends</span> <span class="n">SonarModel</span> <span class="kd">implements</span> <span class="n">ISonarObservable</span>  <span class="p">{</span>
<span class="kd">protected</span> <span class="n">IDistanceMeasured</span> <span class="n">observableDistance</span>  <span class="p">;</span>

<span class="c1">//Factory method</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">ISonarObservable</span> <span class="nf">create</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">simulation</span> <span class="p">)</span>  <span class="k">return</span> <span class="k">new</span> <span class="n">SonarMockObservable</span><span class="p">();</span>
  <span class="k">else</span>  <span class="k">return</span> <span class="k">new</span> <span class="n">SonarConcreteObservable</span><span class="p">();</span>
<span class="p">}</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">IDistance</span> <span class="nf">getDistance</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">observableDistance</span><span class="p">;</span> <span class="p">}</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">register</span><span class="p">(</span><span class="n">IObserver</span> <span class="n">obs</span><span class="p">)</span> <span class="p">{</span> <span class="n">observableDistance</span><span class="p">.</span><span class="na">addObserver</span><span class="p">(</span><span class="n">obs</span><span class="p">);</span> <span class="p">}</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">unregister</span><span class="p">(</span><span class="n">IObserver</span> <span class="n">obs</span><span class="p">)</span> <span class="p">{</span><span class="n">observableDistance</span><span class="p">.</span><span class="na">deleteObserver</span><span class="p">(</span><span class="n">obs</span><span class="p">);}</span>
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">updateDistance</span><span class="p">(</span><span class="kt">int</span> <span class="n">d</span><span class="p">){</span><span class="n">observableDistance</span><span class="p">.</span><span class="na">setVal</span><span class="p">(</span><span class="k">new</span> <span class="n">Distance</span><span class="p">(</span><span class="n">d</span><span class="p">));}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="sonarmockobservable">
<h5>SonarMockObservable<a class="headerlink" href="#sonarmockobservable" title="Permalink to this headline">¶</a></h5>
<p>Ora il SonarMock osservabile può essere definito ridefinendo il metodo asbstract
relativo alla produzione dei dati in modo analogo a quanto fatto per il Sonar:</p>
<div class="highlight-java notranslate" id="id1"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SonarMockObservable</span> <span class="kd">extends</span> <span class="n">SonarModelObservable</span><span class="p">{</span>

<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">sonarSetUp</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">observableDistance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DistanceMeasured</span><span class="p">(</span> <span class="p">);</span>
  <span class="n">observableDistance</span><span class="p">.</span><span class="na">setVal</span><span class="p">(</span><span class="n">curVal</span><span class="p">);</span>
<span class="p">}</span>

<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">sonarProduce</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">testing</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">updateDistance</span><span class="p">(</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">testingDistance</span> <span class="p">);</span>
    <span class="n">stopped</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>  <span class="c1">//one shot</span>
  <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="n">curVal</span><span class="p">.</span><span class="na">getVal</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">updateDistance</span><span class="p">(</span> <span class="n">v</span> <span class="p">);</span>
    <span class="n">stopped</span> <span class="o">=</span> <span class="p">(</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">);</span>
    <span class="n">Utils</span><span class="p">.</span><span class="na">delay</span><span class="p">(</span><span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">sonarDelay</span><span class="p">);</span> <span class="c1">//avoid fast generation</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="sonarconcreteobservable">
<h5>SonarConcreteObservable<a class="headerlink" href="#sonarconcreteobservable" title="Permalink to this headline">¶</a></h5>
<p>Analogamente, la versione osservabile del <a class="reference internal" href="#sonarconcrete">SonarConcrete</a> si ottiene ridefinendo (in assenza di ereditarietà
multipla) i metodi astratti  di <code class="docutils literal notranslate"><span class="pre">setUp</span></code> e <code class="docutils literal notranslate"><span class="pre">sonarProduce</span></code>. Inoltre</p>
<div class="highlight-java notranslate" id="id2"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SonarConcreteObservable</span> <span class="kd">extends</span> <span class="n">SonarModelObservable</span>
<span class="kd">private</span>  <span class="n">BufferedReader</span> <span class="n">reader</span> <span class="p">;</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">lastSonarVal</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kd">private</span> <span class="n">Process</span> <span class="n">p</span>             <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">sonarSetUp</span><span class="p">()</span> <span class="p">{</span>
          <span class="n">observableDistance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DistanceMeasured</span><span class="p">(</span> <span class="p">);</span>
          <span class="n">observableDistance</span><span class="p">.</span><span class="na">setVal</span><span class="p">(</span> <span class="k">new</span> <span class="n">Distance</span><span class="p">(</span><span class="n">lastSonarVal</span><span class="p">)</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">activate</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">p</span> <span class="o">==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
          <span class="n">p</span>      <span class="o">=</span> <span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="s">&quot;sudo ./SonarAlone&quot;</span><span class="p">);</span>
          <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="p">(</span><span class="k">new</span> <span class="n">InputStreamReader</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">()));</span>
      <span class="p">}</span><span class="k">catch</span><span class="p">(</span> <span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{...}</span>
              <span class="p">}</span>
              <span class="kd">super</span><span class="p">.</span><span class="na">activate</span><span class="p">();</span>
  <span class="p">}</span>

<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">sonarProduce</span><span class="p">(</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="na">readLine</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">data</span> <span class="o">==</span> <span class="kc">null</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
    <span class="c1">//Eliminiamo dati del tipo 3430</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">lastSonarVal</span> <span class="o">!=</span> <span class="n">v</span> <span class="o">&amp;&amp;</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">sonarDistanceMax</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">lastSonarVal</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
      <span class="n">updateDistance</span><span class="p">(</span> <span class="n">v</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span><span class="k">catch</span><span class="p">(</span> <span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{...</span> <span class="p">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deactivate</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
          <span class="n">p</span><span class="p">.</span><span class="na">destroy</span><span class="p">();</span>
          <span class="n">p</span><span class="o">=</span><span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">super</span><span class="p">.</span><span class="na">deactivate</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="aggiornamento-di-devicefactory">
<h5>Aggiornamento di DeviceFactory<a class="headerlink" href="#aggiornamento-di-devicefactory" title="Permalink to this headline">¶</a></h5>
<p>La nascita del nuovo tipo di Sonar ci induce a introdurre nuovi metodi in <a class="reference internal" href="#devicefactory">DeviceFactory</a>:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">ISonar</span> <span class="nf">createSonar</span><span class="p">(</span><span class="kt">boolean</span> <span class="n">observable</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">observable</span> <span class="p">)</span> <span class="k">return</span> <span class="n">createSonarObservable</span><span class="p">();</span>
  <span class="k">else</span> <span class="k">return</span> <span class="n">createSonar</span><span class="p">();</span>
  <span class="p">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="n">ISonarObservable</span> <span class="nf">createSonarObservable</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">simulation</span><span class="p">)</span>  <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="n">SonarMockObservable</span><span class="p">();</span>
  <span class="p">}</span><span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="n">SonarConcreteObservable</span><span class="p">();</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="testing-del-sonar-osservabile">
<h5>Testing del Sonar osservabile<a class="headerlink" href="#testing-del-sonar-osservabile" title="Permalink to this headline">¶</a></h5>
<p>Il testing sul <code class="docutils literal notranslate"><span class="pre">SonarMockObservable</span></code> viene qui impostato nel modo che segue:</p>
<ul class="simple">
<li><p>si regola il Sonar in modo che produca un valore costante definito in <code class="docutils literal notranslate"><span class="pre">RadarSystemConfig.testingDistance</span></code></p></li>
<li><p>si introduce (almeno) un observer che controlla che il dato osservato sia quello emesso</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSingleshotSonarObservableMock</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">testing</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="kt">boolean</span> <span class="n">oneShot</span>           <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="n">ISonarObservable</span> <span class="n">sonar</span> <span class="o">=</span> <span class="n">DeviceFactory</span><span class="p">.</span><span class="na">createSonarObservable</span><span class="p">();</span>
  <span class="n">IObserver</span> <span class="n">obs1</span>         <span class="o">=</span> <span class="k">new</span> <span class="n">SonarObserverFortesting</span><span class="p">(</span><span class="s">&quot;obs1&quot;</span><span class="p">,</span><span class="n">oneShot</span><span class="p">)</span> <span class="p">;</span>
  <span class="n">sonar</span><span class="p">.</span><span class="na">register</span><span class="p">(</span> <span class="n">obs1</span> <span class="p">);</span>     <span class="c1">//add then observer</span>
  <span class="n">sonar</span><span class="p">.</span><span class="na">activate</span><span class="p">();</span>
  <span class="kt">int</span> <span class="n">v0</span> <span class="o">=</span> <span class="n">sonar</span><span class="p">.</span><span class="na">getDistance</span><span class="p">().</span><span class="na">getVal</span><span class="p">();</span>
  <span class="n">assertTrue</span><span class="p">(</span>  <span class="n">v0</span> <span class="o">==</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">testingDistance</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>L’<em>observer</em> viene impostato in modo da controllare anche dati emessi da un sonar reale
che opera con ostacolo fisso posto davanti ad esso, alla distanza prefissata.</p>
<div class="highlight-java notranslate" id="sonarobserverfortesting"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">SonarObserverFortesting</span> <span class="kd">implements</span> <span class="n">IObserver</span><span class="p">{</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="p">;</span>
<span class="kd">private</span> <span class="kt">boolean</span> <span class="n">oneShot</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">v0</span>          <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">delta</span>       <span class="o">=</span>  <span class="mi">1</span><span class="p">;</span>
<span class="kd">private</span> <span class="n">ISonarObservable</span> <span class="n">sonar</span><span class="p">;</span>

<span class="kd">public</span> <span class="nf">SonarObserverFortesting</span><span class="p">(</span>
        <span class="n">String</span> <span class="n">name</span><span class="p">,</span><span class="n">ISonarObservable</span> <span class="n">sonar</span><span class="p">,</span><span class="kt">boolean</span> <span class="n">oneShot</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="na">name</span>    <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="na">oneShot</span> <span class="o">=</span> <span class="n">oneShot</span><span class="p">;</span>
<span class="p">}</span>
<span class="nd">@Override</span>  <span class="c1">//from java.util.Observer</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="p">(</span><span class="n">Observable</span> <span class="n">source</span><span class="p">,</span> <span class="n">Object</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="na">toString</span><span class="p">()</span> <span class="p">);</span>
<span class="p">}</span>
<span class="nd">@Override</span> <span class="c1">//from IObserver</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="p">(</span><span class="kt">int</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">oneShot</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">assertTrue</span><span class="p">(</span> <span class="n">value</span> <span class="o">==</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">testingDistance</span> <span class="p">);</span>
  <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">vs</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">v0</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span><span class="c1">//set the first value observed</span>
      <span class="n">v0</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">vexpectedMin</span> <span class="o">=</span> <span class="n">v0</span><span class="o">-</span><span class="n">delta</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">vexpectedMax</span> <span class="o">=</span> <span class="n">v0</span><span class="o">+</span><span class="n">delta</span><span class="p">;</span>
      <span class="n">assertTrue</span><span class="p">(</span><span class="n">value</span><span class="o">&lt;=</span><span class="n">vexpectedMax</span> <span class="o">&amp;&amp;</span> <span class="n">value</span><span class="o">&gt;=</span><span class="n">vexpectedMin</span> <span class="p">);</span>
      <span class="n">v0</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
      <span class="c1">//if( v0 == 30 &amp;&amp; name.equals(&quot;obs1&quot;)) sonar.unregister(this);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="p">}</span><span class="c1">//SonarObserverFortesting</span>
</pre></div>
</div>
<p>Si noti che observer di questo tipo vengono di norma eseguiti all’interno del Thread dell’observable che sta operando
per conto di un qualche client.</p>
</section>
</section>
<section id="il-controller">
<span id="controller"></span><h4>Il Controller<a class="headerlink" href="#il-controller" title="Permalink to this headline">¶</a></h4>
<p>Il componente che realizza la logica applicativa può essere definito partendo dal modello introdotto
nella fase di analisi (<a class="reference internal" href="RadarSystemProdottiAnalisi.html#controllerlogic"><span class="std std-ref">La logica del Controller</span></a>) , attivando un Thread che realizza lo schema <em>read-eval-print</em>.
Nel codice che segue realizzeremo ciascun requisito con un componente specifico:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Controller</span> <span class="p">{</span>
<span class="kd">private</span> <span class="n">ILed</span> <span class="n">led</span><span class="p">;</span>
<span class="kd">private</span> <span class="n">ISonar</span> <span class="n">sonar</span><span class="p">;</span>
<span class="kd">private</span> <span class="n">IRadarDisplay</span> <span class="n">radar</span><span class="p">;</span>
<span class="kd">private</span> <span class="n">ActionFunction</span> <span class="n">endFun</span><span class="p">;</span>

<span class="c1">//Factory method</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">Controller</span> <span class="nf">create</span><span class="p">(</span><span class="n">ILed</span> <span class="n">led</span><span class="p">,</span> <span class="n">ISonar</span> <span class="n">sonar</span><span class="p">,</span><span class="n">IRadarDisplay</span> <span class="n">radar</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">Controller</span><span class="p">(</span> <span class="n">led</span><span class="p">,</span>  <span class="n">sonar</span><span class="p">,</span> <span class="n">radar</span> <span class="p">);</span>
<span class="p">}</span>

<span class="c1">//Constructor</span>
<span class="kd">private</span> <span class="nf">Controller</span><span class="p">(</span> <span class="n">ILed</span> <span class="n">led</span><span class="p">,</span> <span class="n">ISonar</span> <span class="n">sonar</span><span class="p">,</span><span class="n">IRadarDisplay</span> <span class="n">radar</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="na">led</span>    <span class="o">=</span> <span class="n">led</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="na">sonar</span>  <span class="o">=</span> <span class="n">sonar</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="na">radar</span>  <span class="o">=</span> <span class="n">radar</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="p">(</span> <span class="n">ActionFunction</span> <span class="n">endFun</span><span class="p">,</span> <span class="kt">int</span> <span class="n">limit</span>  <span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="na">endFun</span> <span class="o">=</span> <span class="n">endFun</span><span class="p">;</span>
  <span class="n">sonar</span><span class="p">.</span><span class="na">activate</span><span class="p">(</span> <span class="n">limit</span> <span class="p">);</span>
  <span class="n">activate</span><span class="p">(</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Il Controller riceve in ingresso i (riferimenti ai) componenti del sistema e può essere attivato
invocando il metodo <code class="docutils literal notranslate"><span class="pre">start</span></code> il cui argomento <code class="docutils literal notranslate"><span class="pre">n</span></code> fissa un limite massimo al numero delle iterazioni
e il cui argomento <code class="docutils literal notranslate"><span class="pre">endFun</span></code> è una funzione di callback (che verrà invocata
al termine delle attività) e che implementa la seguente interfaccia:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ActionFunction</span> <span class="p">{</span>
  <span class="kt">void</span> <span class="nf">run</span><span class="p">(</span><span class="n">String</span> <span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><span class="remark">La funzione di callback è una chiusura lessicale sul chiamante</span></p>
<p>Il metodo <code class="docutils literal notranslate"><span class="pre">start</span></code> attiva il Sonar e lancia un Thread interno di lavoro.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">activate</span><span class="p">(</span> <span class="kt">int</span> <span class="n">limit</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">new</span> <span class="n">Thread</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="n">sonar</span><span class="p">.</span><span class="na">activate</span><span class="p">();</span>
          <span class="c1">//while( sonarActive() ) {</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">sonar</span><span class="p">.</span><span class="na">isActive</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span><span class="p">(</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;=</span><span class="n">limit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//meglio per il testing ...</span>
              <span class="n">IDistance</span> <span class="n">d</span> <span class="o">=</span> <span class="n">sonar</span><span class="p">.</span><span class="na">getDistance</span><span class="p">();</span>
              <span class="k">if</span><span class="p">(</span> <span class="n">radar</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>  <span class="n">RadarGuiUsecase</span><span class="p">.</span><span class="na">doUseCase</span><span class="p">(</span><span class="n">radar</span><span class="p">,</span><span class="n">d</span><span class="p">);</span>
              <span class="n">LedAlarmUsecase</span><span class="p">.</span><span class="na">doUseCase</span><span class="p">(</span> <span class="n">led</span><span class="p">,</span>  <span class="n">d</span>  <span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="n">sonar</span><span class="p">.</span><span class="na">deactivate</span><span class="p">();</span>
          <span class="n">endFun</span><span class="p">.</span><span class="na">run</span><span class="p">(</span><span class="s">&quot;Controller | BYE &quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span>  <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}.</span><span class="na">start</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Logicamente, la computazione prosegue fintanto che il Sonar è attivo; tuttavia,
la messa a punto del sistema (e il testing) può essere agevolato
limitando a priori il numero di iterazioni.</p>
<p>Notiamo anche che il Controller evita (al momento) di realizzare il requisito <code class="docutils literal notranslate"><span class="pre">radarGui</span></code>
(si veda <a class="reference internal" href="RadarSystem.html#requirements"><span class="std std-ref">Requisiti</span></a>) se riceve in ingresso un riferimento nullo al <code class="docutils literal notranslate"><span class="pre">RadarDisplay</span></code>.</p>
<a class="reference internal image-reference" href="_images/ArchLogicaOOP1.PNG"><img alt="_images/ArchLogicaOOP1.PNG" class="align-center" src="_images/ArchLogicaOOP1.PNG" style="width: 60%;" /></a>
<section id="ledalarmusecase">
<h5>LedAlarmUsecase<a class="headerlink" href="#ledalarmusecase" title="Permalink to this headline">¶</a></h5>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LedAlarmUsecase</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">doUseCase</span><span class="p">(</span><span class="n">ILed</span> <span class="n">led</span><span class="p">,</span> <span class="n">IDistance</span> <span class="n">d</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">d</span><span class="p">.</span><span class="na">getVal</span><span class="p">()</span> <span class="o">&lt;</span>  <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">DLIMIT</span> <span class="p">)</span> <span class="n">led</span><span class="p">.</span><span class="na">turnOn</span><span class="p">();</span>
      <span class="k">else</span>  <span class="n">led</span><span class="p">.</span><span class="na">turnOff</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="radarguiusecase">
<h5>RadarGuiUsecase<a class="headerlink" href="#radarguiusecase" title="Permalink to this headline">¶</a></h5>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RadarGuiUsecase</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">doUseCase</span><span class="p">(</span> <span class="n">IRadarDisplay</span> <span class="n">radar</span><span class="p">,</span> <span class="n">IDistance</span> <span class="n">d</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">radar</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">d</span><span class="p">.</span><span class="na">getVal</span><span class="p">(),</span> <span class="s">&quot;90&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="un-sistema-piu-reattivo">
<h4>Un sistema più reattivo<a class="headerlink" href="#un-sistema-piu-reattivo" title="Permalink to this headline">¶</a></h4>
<p>L’uso di un Sonar osservabile permette di eseguire la business logic del Controller all’interno di un
componente che riceve i dati dal Sonar non appena vengono prodotti.
Prima di affrontare il refactoring del sistema in questo senso, impostiamo l’esecuzione e il testing del
sistema nella versione attuale.</p>
</section>
</section>
</section>
<section id="esecuzione-su-pc-e-su-raspberry">
<h2>Esecuzione su Pc e su Raspberry<a class="headerlink" href="#esecuzione-su-pc-e-su-raspberry" title="Permalink to this headline">¶</a></h2>
<p>D’ora in poi dovremo realizzare diverse versioni/configurazioni del sistema, sia in locale sia
in distribuito. Per agevolare il lancio di queste diverse versioni, impostamo un programma che permette
la scelta di una tra queste in base al suo nome. In particolare:</p>
<ul class="simple">
<li><p>il programma <code class="docutils literal notranslate"><span class="pre">AllMainOnRasp</span></code> permette la scelta di versioni del sistema che girano sul RaspberryPi</p></li>
<li><p>il programma <code class="docutils literal notranslate"><span class="pre">AllMainOnPc</span></code> permette la scelta di versioni del sistema che girano sul Pc</p></li>
</ul>
<p>Per permettere la selezione, introducimo il vincolo che ciascuna
delle versioni del sistema dovrà implementare una precisa interfaccia.</p>
<section id="l-interfaccia-iapplication">
<span id="iapplication"></span><h3>L’interfaccia IApplication<a class="headerlink" href="#l-interfaccia-iapplication" title="Permalink to this headline">¶</a></h3>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IApplication</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doJob</span><span class="p">(</span><span class="n">String</span> <span class="n">configFileName</span><span class="p">);</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Ogni versione del sistema dovrà duque fornire un nome e un metodo <code class="docutils literal notranslate"><span class="pre">doJob</span></code> per essere eseguita,
che riceve in ingresso il file di configurazione.</p>
</section>
<section id="il-sistema-in-locale">
<span id="radarsystemmainlocal"></span><h3>Il sistema in locale<a class="headerlink" href="#il-sistema-in-locale" title="Permalink to this headline">¶</a></h3>
<p>La prima, semplice versione del sistema da eseguire e testare lavora su un singolo computer
(PC o Raspberry) con dispositivi simulati o (nel caso di Raspberry) reali.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RadarSystemMainLocal</span> <span class="kd">implements</span> <span class="n">IApplication</span><span class="p">{</span>
<span class="kd">private</span> <span class="n">ISonar</span> <span class="n">sonar</span>        <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">private</span> <span class="n">ILed</span> <span class="n">led</span>            <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">private</span> <span class="n">IRadarDisplay</span> <span class="n">radar</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">private</span> <span class="n">Controller</span> <span class="n">controller</span><span class="p">;</span>

      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="p">()</span> <span class="p">{</span>       <span class="k">return</span> <span class="s">&quot;RadarSystemMainLocal&quot;</span><span class="p">;</span>  <span class="p">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doJob</span><span class="p">(</span><span class="n">String</span> <span class="n">configFileName</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">setup</span><span class="p">(</span><span class="n">configFileName</span><span class="p">);</span>
  <span class="n">configure</span><span class="p">();</span>
  <span class="n">controller</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
<span class="p">}</span>
  <span class="p">...</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="k">new</span> <span class="n">RadarSystemMainAllOnPc</span><span class="p">().</span><span class="na">doJob</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span> <span class="c1">//su PC</span>
    <span class="c1">//new RadarSystemMainAllOnPc().doJob(&quot;RadarSystemConfig.json&quot;); //su Rasp</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="fase-di-setup">
<h4>Fase di setup<a class="headerlink" href="#fase-di-setup" title="Permalink to this headline">¶</a></h4>
<p>Il metodo <code class="docutils literal notranslate"><span class="pre">setup</span></code> fissa i parametri di  configurazione leggendo il file <code class="docutils literal notranslate"><span class="pre">RadarSystemConfig.json</span></code>
o assegnando loro un valore a livello di programma.
Osserviamo che:</p>
<ul class="simple">
<li><p>Quando attiaviamo il sistema su PC usando un IDE (Eclipse o IntelliJ), conviene fissare i parametri di
configurazione all’interno del codice.</p></li>
<li><p>Quando attiviamo il sistema su Raspberry usando come  distribuzione un file <code class="docutils literal notranslate"><span class="pre">jar</span></code>, conviene
fissare i parametri di  configurazione utilizzando il file <code class="docutils literal notranslate"><span class="pre">RadarSystemConfig.json</span></code>.</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RadarSystemMainLocal</span> <span class="kd">implements</span> <span class="n">IApplication</span><span class="p">{</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setup</span><span class="p">(</span> <span class="n">String</span> <span class="n">configFile</span> <span class="p">)</span>  <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">configFile</span> <span class="o">!=</span> <span class="kc">null</span> <span class="p">)</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">setTheConfiguration</span><span class="p">(</span><span class="n">configFile</span><span class="p">);</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">testing</span>                 <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">sonarDelay</span>       <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
  <span class="c1">//Su PC</span>
    <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">simulation</span>              <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">DLIMIT</span>                  <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
    <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">ledGui</span>          <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">RadarGuiRemote</span>  <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="c1">//Su Raspberry (nel file di configurazione)</span>
    <span class="c1">//RadarSystemConfig.simulation    = false;</span>
    <span class="c1">//RadarSystemConfig.DLIMIT        = 12;</span>
    <span class="c1">//RadarSystemConfig.ledGui         = false;</span>
    <span class="c1">//RadarSystemConfig.RadarGuiRemote = true;</span>
  <span class="p">}</span>
<span class="p">}</span><span class="c1">//setup</span>
 <span class="p">...</span>
<span class="p">}</span><span class="c1">//RadarSystemMainLocal</span>
</pre></div>
</div>
</section>
<section id="fase-di-configurazione">
<h4>Fase di configurazione<a class="headerlink" href="#fase-di-configurazione" title="Permalink to this headline">¶</a></h4>
<p>Il metodo <code class="docutils literal notranslate"><span class="pre">configure</span></code> crea i dispositivi simulati concreti a seconda dei parametri di
configurazione.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">//Dispositivi di Input</span>
    <span class="n">sonar</span>      <span class="o">=</span> <span class="n">DeviceFactory</span><span class="p">.</span><span class="na">createSonar</span><span class="p">();</span>
  <span class="c1">//Dispositivi di Output</span>
    <span class="n">led</span>        <span class="o">=</span> <span class="n">DeviceFactory</span><span class="p">.</span><span class="na">createLed</span><span class="p">();</span>
    <span class="n">radar</span>      <span class="o">=</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">RadarGuiRemote</span> <span class="o">?</span>
                     <span class="kc">null</span> <span class="p">:</span> <span class="n">DeviceFactory</span><span class="p">.</span><span class="na">createRadarGui</span><span class="p">();</span>
  <span class="c1">//Controller</span>
    <span class="n">ActionFunction</span> <span class="n">endFun</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">n</span><span class="p">);</span> <span class="n">terminate</span><span class="p">();</span> <span class="p">};</span>
    <span class="n">controller</span> <span class="o">=</span> <span class="n">Controller</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">led</span><span class="p">,</span> <span class="n">sonar</span><span class="p">,</span> <span class="n">radar</span><span class="p">,</span> <span class="n">endFun</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="utilita-per-il-testing">
<h4>Utilità per il testing<a class="headerlink" href="#utilita-per-il-testing" title="Permalink to this headline">¶</a></h4>
<p>Inseriamo nel main program  metodi che restitusicono un riferimento ai componenti del sistema:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RadarSystemMainLocal</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="kd">public</span> <span class="n">IRadarDisplay</span> <span class="nf">getRadarGui</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">radar</span><span class="p">;</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="n">ILed</span> <span class="nf">getLed</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">led</span><span class="p">;</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="n">ISonar</span> <span class="nf">getSonar</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">sonar</span><span class="p">;</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="n">Controller</span> <span class="nf">getController</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">controller</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="testing-su-pc">
<h3>Testing (su PC)<a class="headerlink" href="#testing-su-pc" title="Permalink to this headline">¶</a></h3>
<p>La testUnit introduce un metodo di setup per definire i parametri di configurazione
(in modo da non dipendere da files esterni) e per costruire il sistema.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestBehaviorLocal</span> <span class="p">{</span>
<span class="kd">private</span> <span class="n">RadarSystemMainLocal</span> <span class="n">sys</span><span class="p">;</span>
  <span class="nd">@Before</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;setUp&quot;</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="n">sys</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RadarSystemMainLocal</span><span class="p">();</span>
      <span class="n">sys</span><span class="p">.</span><span class="na">setup</span><span class="p">(</span> <span class="kc">null</span> <span class="p">);</span>  <span class="c1">//non usiamo il file di configurazione</span>
      <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">testing</span>               <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">tracing</span>               <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fail</span><span class="p">(</span><span class="s">&quot;setup ERROR &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">()</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
</pre></div>
</div>
<p>Come anticipato in fase di analisi dei requisiti, impostiamo un test nel caso in cui
il Sonar produca un valore <code class="docutils literal notranslate"><span class="pre">d&gt;DLIMIT</span></code> e un altro test per il Sonar che produce un valore <code class="docutils literal notranslate"><span class="pre">d&lt;DLIMIT</span></code>.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testFarDistance</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">testingDistance</span> <span class="o">=</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">DLIMIT</span> <span class="o">+</span> <span class="mi">20</span><span class="p">;</span>
  <span class="n">testTheDistance</span><span class="p">(</span> <span class="kc">false</span> <span class="p">);</span>
<span class="p">}</span>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testNearDistance</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">testingDistance</span> <span class="o">=</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">DLIMIT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">testTheDistance</span><span class="p">(</span> <span class="kc">true</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">testTheDistance</span><span class="p">(</span> <span class="kt">boolean</span> <span class="n">ledStateExpected</span> <span class="p">)</span> <span class="p">{</span>
  <span class="n">RadarDisplay</span> <span class="n">radar</span> <span class="o">=</span> <span class="n">RadarDisplay</span><span class="p">.</span><span class="na">getRadarDisplay</span><span class="p">();</span>  <span class="c1">//singleton</span>
  <span class="n">ActionFunction</span> <span class="n">endFun</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span>  <span class="c1">//eseguita quando il Controller termina</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
    <span class="kt">boolean</span> <span class="n">ledState</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="na">getLed</span><span class="p">().</span><span class="na">getState</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">radarDisplayedDistance</span> <span class="o">=</span> <span class="n">radar</span><span class="p">.</span><span class="na">getCurDistance</span><span class="p">();</span>
    <span class="n">assertTrue</span><span class="p">(</span>  <span class="n">ledState</span> <span class="o">==</span> <span class="n">ledStateExpected</span>
                              <span class="o">&amp;&amp;</span> <span class="n">radarDisplayedDistance</span> <span class="o">==</span> <span class="n">RadarSystemConfig</span><span class="p">.</span><span class="na">testingDistance</span><span class="p">);</span>
              <span class="p">};</span>
  <span class="n">sys</span><span class="p">.</span><span class="na">getController</span><span class="p">().</span><span class="na">start</span><span class="p">(</span> <span class="n">endFun</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span> <span class="c1">//one-shot</span>
  <span class="n">Utils</span><span class="p">.</span><span class="na">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="p">;</span> <span class="c1">//give time to work ...</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="il-sistema-su-raspberrypi">
<span id="radarsystemmainlocalonrasp"></span><h3>Il sistema su RaspberryPi<a class="headerlink" href="#il-sistema-su-raspberrypi" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Impostazione del main file in <code class="docutils literal notranslate"><span class="pre">build.gradle</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mainClassName</span> <span class="o">=</span> <span class="s1">&#39;it.unibo.enablerCleanArch.main.AllMainOnRasp&#39;</span>
</pre></div>
</div>
</li>
<li><p>Creazione del file di distribuzione</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gradle</span> <span class="n">distZip</span> <span class="o">-</span><span class="n">x</span> <span class="n">test</span>
</pre></div>
</div>
</li>
<li><p>Trasferimento del file <code class="docutils literal notranslate"><span class="pre">it.unibo.enablerCleanArch-1.0.zip</span></code> su RaspberryPi e unzipping</p></li>
<li><p>Posizionamento nella directory di lavoro:  <code class="docutils literal notranslate"><span class="pre">it.unibo.enablerCleanArch-1.0/bin</span></code></p></li>
<li><p>Impostazione dei parametri di configurazione nel file <code class="docutils literal notranslate"><span class="pre">RadarSystemConfig.json</span></code> nella directory di lavoro</p></li>
<li><p>Esecuzione di <code class="docutils literal notranslate"><span class="pre">./it.unibo.enablerCleanArch</span></code></p></li>
</ol>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="index.html">
    <img class="logo" src="_static/logo-unibo.gif" alt="Logo"/>
    
    <h1 class="logo logo-name">iss22</h1>
    
  </a>
</p>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="RadarSystem.html">RadarSystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="RadarSystemAnalisi.html">Analisi del problema RadarSystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="RadarSystemProdottiAnalisi.html">Prodotti al termine della analisi</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Progettazione e sviluppo incrementali</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#il-primo-sprint-componenti-per-i-dispositivi-di-i-o">Il primo SPRINT: Componenti per i dispositivi di I/O</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#devicefactory-e-file-di-configurazione">DeviceFactory e file di configurazione</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#la-classe-colorsout">La classe <code class="docutils literal notranslate"><span class="pre">ColorsOut</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#dispositivi-reali-e-mock">Dispositivi reali e Mock</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#il-led">Il Led</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#la-classe-astratta-ledmodel">La classe astratta LedModel</a></li>
<li class="toctree-l5"><a class="reference internal" href="#il-ledmock">Il LedMock</a></li>
<li class="toctree-l5"><a class="reference internal" href="#il-ledconcrete">Il LedConcrete</a></li>
<li class="toctree-l5"><a class="reference internal" href="#testing-del-dispositivo-led">Testing del dispositivo Led</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#il-sonar">Il Sonar</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#la-classe-astratta-sonarmodel">La classe astratta SonarModel</a></li>
<li class="toctree-l5"><a class="reference internal" href="#la-classe-distance">La classe Distance</a></li>
<li class="toctree-l5"><a class="reference internal" href="#la-produzione-dei-dati">La produzione dei dati</a></li>
<li class="toctree-l5"><a class="reference internal" href="#il-sonarmock">Il SonarMock</a></li>
<li class="toctree-l5"><a class="reference internal" href="#il-sonarconcrete">Il SonarConcrete</a></li>
<li class="toctree-l5"><a class="reference internal" href="#testing-del-dispositivo-sonar">Testing del dispositivo Sonar</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#il-sonar-osservabile">Il Sonar osservabile</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#la-distanza-come-risorsa-osservabile">La distanza come risorsa osservabile</a></li>
<li class="toctree-l5"><a class="reference internal" href="#sonarmodelobservable">SonarModelObservable</a></li>
<li class="toctree-l5"><a class="reference internal" href="#sonarmockobservable">SonarMockObservable</a></li>
<li class="toctree-l5"><a class="reference internal" href="#sonarconcreteobservable">SonarConcreteObservable</a></li>
<li class="toctree-l5"><a class="reference internal" href="#aggiornamento-di-devicefactory">Aggiornamento di DeviceFactory</a></li>
<li class="toctree-l5"><a class="reference internal" href="#testing-del-sonar-osservabile">Testing del Sonar osservabile</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#il-controller">Il Controller</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#ledalarmusecase">LedAlarmUsecase</a></li>
<li class="toctree-l5"><a class="reference internal" href="#radarguiusecase">RadarGuiUsecase</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#un-sistema-piu-reattivo">Un sistema più reattivo</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#esecuzione-su-pc-e-su-raspberry">Esecuzione su Pc e su Raspberry</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#l-interfaccia-iapplication">L’interfaccia IApplication</a></li>
<li class="toctree-l3"><a class="reference internal" href="#il-sistema-in-locale">Il sistema in locale</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#fase-di-setup">Fase di setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fase-di-configurazione">Fase di configurazione</a></li>
<li class="toctree-l4"><a class="reference internal" href="#utilita-per-il-testing">Utilità per il testing</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#testing-su-pc">Testing (su PC)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#il-sistema-su-raspberrypi">Il sistema su RaspberryPi</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="RadarSystemSupporti.html">Supporti per TCP (SPRINT1)</a></li>
<li class="toctree-l1"><a class="reference internal" href="Enablers.html">Enablers (SPRINT2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="ContextServer.html">Il concetto di contesto</a></li>
<li class="toctree-l1"><a class="reference internal" href="RadarGuiCoap.html">RadarGuiCoap</a></li>
<li class="toctree-l1"><a class="reference internal" href="RadarSystemCoap.html">Il RadarSystem basato su CoAP</a></li>
<li class="toctree-l1"><a class="reference internal" href="RadarSystemDeploy.html">RadarSystem deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="ApproccioTopDown.html">Un approccio top-down al processo</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="RadarSystemProdottiAnalisi.html" title="previous chapter">Prodotti al termine della analisi</a></li>
      <li>Next: <a href="RadarSystemSupporti.html" title="next chapter">Supporti per TCP (SPRINT1)</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Antonio Natali.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.4.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/RadarSystemProgetto.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>