
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />

    <title>Web sockets &#8212; websocket 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Welcome to websocket’s documentation!" href="index.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="contents topic" id="contenuti">
<p class="topic-title">Contenuti</p>
<ul class="simple">
<li><p><a class="reference internal" href="#web-sockets" id="id2">Web sockets</a></p>
<ul>
<li><p><a class="reference internal" href="#websocket-in-springboot-versione-base" id="id3">WebSocket in SpringBoot: versione base</a></p>
<ul>
<li><p><a class="reference internal" href="#setup" id="id4">Setup</a></p></li>
<li><p><a class="reference internal" href="#wsminimal-js" id="id5">wsminimal.js</a></p></li>
<li><p><a class="reference internal" href="#funzioni-di-input-output" id="id6">Funzioni di input/output</a></p></li>
<li><p><a class="reference internal" href="#funzioni-di-connessione-e-ricezione-messaggi" id="id7">Funzioni di connessione e ricezione messaggi</a></p></li>
<li><p><a class="reference internal" href="#configurazione" id="id8">Configurazione</a></p></li>
<li><p><a class="reference internal" href="#handler" id="id9">Handler</a></p></li>
<li><p><a class="reference internal" href="#propagazione-a-tutti-i-client" id="id10">Propagazione a tutti i client</a></p></li>
<li><p><a class="reference internal" href="#un-client-in-java" id="id11">Un client in Java</a></p></li>
<li><p><a class="reference internal" href="#introduzione-di-un-controller" id="id12">Introduzione di un Controller</a></p></li>
<li><p><a class="reference internal" href="#gestione-di-immagini" id="id13">Gestione di immagini</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#websocket-in-springboot-versione-stomp" id="id14">WebSocket in SpringBoot: versione STOMP</a></p>
<ul>
<li><p><a class="reference internal" href="#setup-e-dipendenze" id="id15">Setup e Dipendenze</a></p></li>
<li><p><a class="reference internal" href="#websocket-vs-sockjs" id="id16">WebSocket vs. SockJs</a></p></li>
<li><p><a class="reference internal" href="#id1" id="id17">Configurazione</a></p></li>
<li><p><a class="reference internal" href="#la-funzione-del-servizio" id="id18">La funzione del servizio</a></p></li>
<li><p><a class="reference internal" href="#il-controller" id="id19">Il controller</a></p></li>
<li><p><a class="reference internal" href="#componenti" id="id20">Componenti</a></p></li>
<li><p><a class="reference internal" href="#index-html" id="id21">index.html</a></p></li>
<li><p><a class="reference internal" href="#client-in-javascript-per-browser" id="id22">Client (in javascript per browser)</a></p></li>
<li><p><a class="reference internal" href="#client-in-java-per-programmi" id="id23">Client (in Java per programmi)</a></p></li>
<li><p><a class="reference internal" href="#esempio-piu-articolato" id="id24">Esempio più articolato</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<section id="web-sockets">
<span id="websockets"></span><h1><a class="toc-backref" href="#id2">Web sockets</a><a class="headerlink" href="#web-sockets" title="Permalink to this headline">¶</a></h1>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">anaconda</span>
<span class="n">sphinx</span><span class="o">-</span><span class="n">quickstart</span>
</pre></div>
</div>
<p><a class="reference external" href="https://it.wikipedia.org/wiki/WebSocket">WebSocket</a> è un protocollo che consente a due o più computer di comunicare tra loro
contemporaneamente (full-duplex) su una singola connessione TCP.
È uno strato molto sottile su TCP che trasforma un flusso di byte in un flusso di messaggi
(testo o binario).</p>
<p>Nella sua forma più semplice,</p>
<p><span class="remark">un WebSocket è solo un canale di comunicazione tra due applicazioni</span></p>
<p>e non deve essere necessariamente coinvolto un browser.</p>
<p>A differenza di HTTP, che è un protocollo a livello di applicazione, nel protocollo WebSocket
semplicemente non ci sono abbastanza informazioni in un messaggio in arrivo affinché
un framework o un container sappia come instradarlo o elaborarlo.</p>
<p>Per questo motivo il WebSocket RFC definisce l’uso di sottoprotocolli.
Durante l’handshake, il client e il server possono utilizzare l’intestazione
<em>Sec-WebSocket-Protocol</em> per <span class="blue">concordare un sottoprotocollo</span>, ovvero un protocollo
a livello di applicazione superiore da utilizzare.
L’uso di un sottoprotocollo non è richiesto, ma anche se non utilizzato, le applicazioni
dovranno comunque scegliere un formato di messaggio che sia il client che il server
possano comprendere.</p>
<p>Tuttavia l’uso più comune di WebSocket è facilitare la comunicazione tra un un’applicazione
server e un’applicazione basata su browser.
Infatti, rispetto a HTTP RESTful ha il vantaggio di realizzare comunicazioni  a
bidirezionali e in tempo reale. Ciò consente al server di inviare informazione al client
in qualsiasi momento, anziché costringere il client al polling.</p>
<p>I WebSocket utilizzano le Socket nella loro implementazione basata su un protocollo standard
che definisce un <em>handshake</em> di connessione e un <em>frame</em> di messaggio.</p>
<section id="websocket-in-springboot-versione-base">
<h2><a class="toc-backref" href="#id3">WebSocket in SpringBoot: versione base</a><a class="headerlink" href="#websocket-in-springboot-versione-base" title="Permalink to this headline">¶</a></h2>
<p>Come primo semplice esempio di uso di WebSocket in Spring, creiamo una applicazione che consente
a un client di utilizzare un browser per inviare un messaggio o una immagine a un server
che provvede a visualizzare il messaggio o l’immagine presso tutti i client collegati.</p>
<section id="setup">
<span id="setupnostomp"></span><h3><a class="toc-backref" href="#id4">Setup</a><a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h3>
<p>Come primo semplice esempio di uso di WebSocket in Spring, creiamo una applicazione che consente a un client
di utilizzare un browser per inviare un messaggio o una immagine a un server che provvede a visualizzare
il messaggio o l’immagine presso tutti i client collegati.</p>
<ol class="arabic">
<li><p>Iniziamo creando una applicazione <em>SpringBoot</em> collegandoci a <a class="reference external" href="https://start.spring.io/">Springio</a> e selezionando
come da figura:</p></li>
<li><p>Specifichiamo una nuova porta (il deafult è <code class="docutils literal notranslate"><span class="pre">8080</span></code>) ponendo in <em>resources/application.properties</em></p>
<blockquote>
<div><div class="highlight-Java notranslate"><div class="highlight"><pre><span></span><span class="n">server</span><span class="p">.</span><span class="na">port</span> <span class="o">=</span> <span class="mi">8070</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Inseriamo un file <code class="docutils literal notranslate"><span class="pre">index.html</span></code> in <strong>resources/static</strong> per poter lanciare un’applicazione che
presenta un’area  di ouput per  la visualizzazione di messaggi e un’area di input per la loro
immissione</p>
<blockquote>
<div><div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
        <span class="p">.</span><span class="nc">messageAreaStyle</span> <span class="p">{</span>
            <span class="k">text-align</span><span class="p">:</span> <span class="kc">left</span><span class="p">;</span>
            <span class="k">width</span><span class="p">:</span> <span class="mi">50</span><span class="o">+</span><span class="p">;</span>
            <span class="k">padding</span><span class="p">:</span> <span class="mi">1</span><span class="kt">em</span><span class="p">;</span>
            <span class="k">border</span><span class="p">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="kc">solid</span> <span class="kc">black</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>wsdemoNoStomp client<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Welcome<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;messageArea&quot;</span>  <span class="na">class</span><span class="o">=</span><span class="s">&quot;messageAreaStyle&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;input-fields&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Type a message and hit send:<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;inputmessage&quot;</span><span class="p">/&gt;&lt;</span><span class="nt">button</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;send&quot;</span><span class="p">&gt;</span>Send<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;wsdemominimal.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>La pagina iniziale si presenta come segue:</p>
</div></blockquote>
</li>
</ol>
</section>
<section id="wsminimal-js">
<h3><a class="toc-backref" href="#id5">wsminimal.js</a><a class="headerlink" href="#wsminimal-js" title="Permalink to this headline">¶</a></h3>
<p>Lo script  <code class="docutils literal notranslate"><span class="pre">wsminimal.js</span></code> definisce funzioni che inviano al server il messaggio di input e che aggiungono
messaggi nella output area e funzioni per connettersi a una WebSocket.</p>
</section>
<section id="funzioni-di-input-output">
<h3><a class="toc-backref" href="#id6">Funzioni di input/output</a><a class="headerlink" href="#funzioni-di-input-output" title="Permalink to this headline">¶</a></h3>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span> <span class="nx">messageWindow</span>   <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;messageArea&quot;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">sendButton</span>      <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;send&quot;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">messageInput</span>    <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;inputmessage&quot;</span><span class="p">);</span>

<span class="nx">sendButton</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">sendMessage</span><span class="p">(</span><span class="nx">messageInput</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
    <span class="nx">messageInput</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">sendMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
    <span class="nx">addMessageToWindow</span><span class="p">(</span><span class="s2">&quot;Sent Message: &quot;</span> <span class="o">+</span> <span class="nx">message</span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">addMessageToWindow</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">messageWindow</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">+=</span> <span class="sb">`&lt;div&gt;</span><span class="si">${</span><span class="nx">message</span><span class="si">}</span><span class="sb">&lt;/div&gt;`</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">connect</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="funzioni-di-connessione-e-ricezione-messaggi">
<h3><a class="toc-backref" href="#id7">Funzioni di connessione e ricezione messaggi</a><a class="headerlink" href="#funzioni-di-connessione-e-ricezione-messaggi" title="Permalink to this headline">¶</a></h3>
<div class="highlight-js notranslate" id="connect"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">connect</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">socket</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">host</span>     <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">host</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">pathname</span> <span class="o">=</span>  <span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">pathname</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">addr</span>     <span class="o">=</span> <span class="s2">&quot;ws://&quot;</span> <span class="o">+</span><span class="nx">host</span> <span class="o">+</span> <span class="nx">pathname</span> <span class="o">+</span> <span class="s2">&quot;socket&quot;</span>  <span class="p">;</span>

    <span class="c1">// Assicura che sia aperta un unica connessione</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">socket</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!==</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">CLOSED</span><span class="p">){</span>
         <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;WARNING: Connessione WebSocket già stabilita&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="nx">addr</span><span class="p">);</span> <span class="c1">//CONNESSIONE</span>

    <span class="nx">socket</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">addMessageToWindow</span><span class="p">(</span><span class="s2">&quot;Connected&quot;</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">addMessageToWindow</span><span class="p">(</span><span class="sb">`Got Message: </span><span class="si">${</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="nx">socket</span><span class="p">;</span>
<span class="p">}</span><span class="c1">//connect</span>
</pre></div>
</div>
</section>
<section id="configurazione">
<h3><a class="toc-backref" href="#id8">Configurazione</a><a class="headerlink" href="#configurazione" title="Permalink to this headline">¶</a></h3>
<p>Affinché l’applicazione Spring inoltri le richieste di un client al server (l’endpoint),
è necessario registrare un gestore utilizzando una classe di configurazione
che implementa l’interfaccia <code class="docutils literal notranslate"><span class="pre">WebSocketConfigurer</span></code>.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Configuration</span>
<span class="nd">@EnableWebSocket</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebSocketConfiguration</span> <span class="kd">implements</span> <span class="n">WebSocketConfigurer</span> <span class="p">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerWebSocketHandlers</span><span class="p">(</span><span class="n">WebSocketHandlerRegistry</span> <span class="n">registry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">registry</span><span class="p">.</span><span class="na">addHandler</span><span class="p">(</span><span class="k">new</span> <span class="n">WebSocketHandler</span><span class="p">(),</span> <span class="s">&quot;/socket&quot;</span><span class="p">).</span><span class="na">setAllowedOrigins</span><span class="p">(</span><span class="s">&quot;*&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>L’annotazione <code class="docutils literal notranslate"><span class="pre">&#64;EnableWebSocket</span></code> (da aggiungere a una classe di configurazione <code class="docutils literal notranslate"><span class="pre">&#64;Configuration</span></code> )
abilita l’uso delle plain WebSocket.</p>
<p>In base alla configurazione, il server risponderà a richieste inviate al seguente indirizzo:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nl">ws:</span><span class="c1">//&lt;serverIP&gt;:8070/socket</span>
</pre></div>
</div>
</section>
<section id="handler">
<h3><a class="toc-backref" href="#id9">Handler</a><a class="headerlink" href="#handler" title="Permalink to this headline">¶</a></h3>
<p>La classe  <code class="docutils literal notranslate"><span class="pre">WebSocketHandler</span></code> definisce un gestore custom di messaggi come specializzazione della classe astratta
<code class="docutils literal notranslate"><span class="pre">AbstractWebSocketHandler</span></code> (o delle sue sottoclassi <code class="docutils literal notranslate"><span class="pre">TextWebSocketHandler</span></code> o <code class="docutils literal notranslate"><span class="pre">BinaryWebSocketHandler</span></code>).</p>
<p>Nel nostro caso, la gestione reinvia sulla WebSocket il messaggio ricevuto .
Questa azione del server porrà in esecuzione sul client  l’operazione <code class="docutils literal notranslate"><span class="pre">socket.onmessage</span></code> (si veda) <a class="reference internal" href="#connect">connect</a>) che visualizza
il messaggio nell’area di output.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebSocketHandler</span> <span class="kd">extends</span> <span class="n">AbstractWebSocketHandler</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">handleTextMessage</span><span class="p">(</span><span class="n">WebSocketSession</span> <span class="n">session</span><span class="p">,</span> <span class="n">TextMessage</span> <span class="n">message</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;New Text Message Received&quot;</span><span class="p">);</span>
        <span class="n">session</span><span class="p">.</span><span class="na">sendMessage</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">handleBinaryMessage</span><span class="p">(</span><span class="n">WebSocketSession</span> <span class="n">session</span><span class="p">,</span> <span class="n">BinaryMessage</span> <span class="n">message</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;New Binary Message Received&quot;</span><span class="p">);</span>
        <span class="n">session</span><span class="p">.</span><span class="na">sendMessage</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="propagazione-a-tutti-i-client">
<h3><a class="toc-backref" href="#id10">Propagazione a tutti i client</a><a class="headerlink" href="#propagazione-a-tutti-i-client" title="Permalink to this headline">¶</a></h3>
<p>Per propagare un messaggio a tutti i client connessi attraverso la WebSocket, basata tenere traccia
delle sessioni e</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebSocketHandler</span> <span class="kd">extends</span> <span class="n">AbstractWebSocketHandler</span> <span class="p">{</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">WebSocketSession</span><span class="o">&gt;</span> <span class="n">sessions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CopyOnWriteArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterConnectionEstablished</span><span class="p">(</span><span class="n">WebSocketSession</span> <span class="n">session</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="n">sessions</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Added the session:&quot;</span> <span class="o">+</span> <span class="n">session</span><span class="p">);</span>
    <span class="kd">super</span><span class="p">.</span><span class="na">afterConnectionEstablished</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
<span class="p">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterConnectionClosed</span><span class="p">(</span><span class="n">WebSocketSession</span> <span class="n">session</span><span class="p">,</span> <span class="n">CloseStatus</span> <span class="n">status</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="n">sessions</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Removed the session:&quot;</span> <span class="o">+</span> <span class="n">session</span><span class="p">);</span>
    <span class="kd">super</span><span class="p">.</span><span class="na">afterConnectionClosed</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">handleTextMessage</span><span class="p">(</span><span class="n">WebSocketSession</span> <span class="n">session</span><span class="p">,</span> <span class="n">TextMessage</span> <span class="n">message</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="p">{</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;New Text Message Received&quot;</span><span class="p">);</span>
    <span class="n">sendToAll</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">sendToAll</span><span class="p">(</span><span class="n">TextMessage</span> <span class="n">message</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">{</span>
    <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">WebSocketSession</span><span class="o">&gt;</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">sessions</span><span class="p">.</span><span class="na">iterator</span><span class="p">();</span>
    <span class="k">while</span><span class="p">(</span> <span class="n">iter</span><span class="p">.</span><span class="na">hasNext</span><span class="p">()</span> <span class="p">){</span>
        <span class="n">iter</span><span class="p">.</span><span class="na">next</span><span class="p">().</span><span class="na">sendMessage</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Notiamo che l’applicazione funziona anche in assenza di un controller, in quanto Spring utilizza di deafult il file
<strong>resources/static/index.html</strong>.</p>
</section>
<section id="un-client-in-java">
<h3><a class="toc-backref" href="#id11">Un client in Java</a><a class="headerlink" href="#un-client-in-java" title="Permalink to this headline">¶</a></h3>
<p>E’ un esempio di machine-to-machine interaction.</p>
<p>La classe <code class="docutils literal notranslate"><span class="pre">WebsocketClientEndpoint</span></code> riproduce in Java la stessa struttura del client già
vista in JavaScript; in più possiamo ora salvare su file l’informnazione ricevuta (in particolare immagini
di tipo <code class="docutils literal notranslate"><span class="pre">jpg</span></code>).</p>
<p>L’annotazione <code class="docutils literal notranslate"><span class="pre">&#64;ClientEndpoint</span></code> (che corrisponde alla interfaccia <code class="docutils literal notranslate"><span class="pre">javax.websocket.ClientEndpoint</span></code>)
denota che un POJO è un web socket client. Come tale questo POJO può definire i metodi delle web socket lifecycle
usando le <em>web socket method level annotations</em>.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@ClientEndpoint</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebsocketClientEndpoint</span> <span class="p">{</span>

<span class="n">Session</span> <span class="n">userSession</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">private</span> <span class="n">IMessageHandler</span> <span class="n">messageHandler</span><span class="p">;</span>

<span class="kd">public</span> <span class="nf">WebsocketClientEndpoint</span><span class="p">(</span><span class="n">URI</span> <span class="n">endpointURI</span><span class="p">)</span> <span class="p">{</span>
 <span class="k">try</span> <span class="p">{</span>
    <span class="n">WebSocketContainer</span> <span class="n">container</span><span class="o">=</span>
            <span class="n">ContainerProvider</span><span class="p">.</span><span class="na">getWebSocketContainer</span><span class="p">();</span>
    <span class="n">container</span><span class="p">.</span><span class="na">connectToServer</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">endpointURI</span><span class="p">);</span>
 <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span> <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Callback hook for Connection open events.</span>
<span class="cm"> * @param userSession the userSession which is opened.</span>
<span class="cm">*/</span>
<span class="nd">@OnOpen</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onOpen</span><span class="p">(</span><span class="n">Session</span> <span class="n">userSession</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="na">userSession</span> <span class="o">=</span> <span class="n">userSession</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Callback hook for Connection close events.</span>
<span class="cm"> * @param userSession the userSession which is getting closed.</span>
<span class="cm"> * @param reason the reason for connection close</span>
<span class="cm">*/</span>
<span class="nd">@OnClose</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClose</span><span class="p">(</span><span class="n">Session</span> <span class="n">userSession</span><span class="p">,</span> <span class="n">CloseReason</span> <span class="n">reason</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="na">userSession</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Callback hook for Message Events.</span>
<span class="cm"> * This method will be invoked when a client send a message.</span>
<span class="cm">*/</span>
<span class="nd">@OnMessage</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="p">(</span><span class="n">String</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">messageHandler</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">messageHandler</span><span class="p">.</span><span class="na">handleMessage</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nd">@OnMessage</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="p">(</span><span class="n">ByteBuffer</span> <span class="n">bytes</span><span class="p">)</span> <span class="p">{</span>
 <span class="k">try</span><span class="p">{</span>
    <span class="n">ByteArrayInputStream</span> <span class="n">bis</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayInputStream</span><span class="p">(</span><span class="n">bytes</span><span class="p">.</span><span class="na">array</span><span class="p">());</span>
    <span class="c1">//Dai bytes alla immagine e salvataggio in un file</span>
    <span class="n">BufferedImage</span> <span class="n">bImage2</span>    <span class="o">=</span> <span class="n">ImageIO</span><span class="p">.</span><span class="na">read</span><span class="p">(</span><span class="n">bis</span><span class="p">);</span>
    <span class="n">ImageIO</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">bImage2</span><span class="p">,</span> <span class="s">&quot;jpg&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="n">File</span><span class="p">(</span><span class="s">&quot;outputimage.jpg&quot;</span><span class="p">)</span> <span class="p">);</span>
 <span class="p">}</span><span class="k">catch</span><span class="p">(</span> <span class="n">Exception</span> <span class="n">e</span><span class="p">){</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span> <span class="p">}</span>

<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * register message handler</span>
<span class="cm">  * @param msgHandler</span>
<span class="cm">*/</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">addMessageHandler</span><span class="p">(</span><span class="n">IMessageHandler</span> <span class="n">msgHandler</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="na">messageHandler</span> <span class="o">=</span> <span class="n">msgHandler</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * Send a message.</span>
<span class="cm"> * @param message</span>
<span class="cm">*/</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendMessage</span><span class="p">(</span><span class="n">String</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="na">userSession</span><span class="p">.</span><span class="na">getAsyncRemote</span><span class="p">().</span><span class="na">sendText</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="introduzione-di-un-controller">
<h3><a class="toc-backref" href="#id12">Introduzione di un Controller</a><a class="headerlink" href="#introduzione-di-un-controller" title="Permalink to this headline">¶</a></h3>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">it.unibo.wsdemoNoSTOMP</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span>

<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebSocketController</span> <span class="p">{</span>
    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">textOnly</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;indexNoImages&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;/alsoimages&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">alsoImages</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;indexAlsoImages&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="gestione-di-immagini">
<h3><a class="toc-backref" href="#id13">Gestione di immagini</a><a class="headerlink" href="#gestione-di-immagini" title="Permalink to this headline">¶</a></h3>
<p>Lo script  <code class="docutils literal notranslate"><span class="pre">wsalsoimages.js</span></code> usato da <code class="docutils literal notranslate"><span class="pre">indexAlsoImages.html</span></code> definisce funzioni per la gestione delle immagini simili</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>sendImageButton.onclick = function (event) { //event is a PointerEvent
    let file = fileInput.files[0];  //file: object File
    sendMessage(file);
    fileInput.value = null;
};

socket.onmessage = function (event) {
    if (event.data instanceof ArrayBuffer) {
        addMessageToWindow(&#39;Got Image:&#39;);
        addImageToWindow(event.data);
    } else {
        addMessageToWindow(`Got Message: ${event.data}`);
    }
};

function addImageToWindow(image) {
    let url = URL.createObjectURL(new Blob([image]));
    imageWindow.innerHTML += `&lt;img src=&quot;${url}&quot;/&gt;`
}
</pre></div>
</div>
</section>
</section>
<section id="websocket-in-springboot-versione-stomp">
<h2><a class="toc-backref" href="#id14">WebSocket in SpringBoot: versione STOMP</a><a class="headerlink" href="#websocket-in-springboot-versione-stomp" title="Permalink to this headline">¶</a></h2>
<p><span class="blue">Simple Text Oriented Message Protocol</span>
(STOMP) è un protocollo di messaggistica text-based progettato per operare con MOM
(Message Orinented Middleware) ed originariamente creato per l’uso
in linguaggi di scripting con frame ispirati a HTTP.
E’ una alternativa a AMQP (Advanced Message Queuing Protocol) e JMS (Java Messaging Service).</p>
<p>STOMP può essere utilizzato anche senza WebSocket, ad esempio tramite una connessione
Telnet, HTTP o un  message broker. Tuttavia,
STOMP è ampiamente supportato e adatto per l’uso su WebSocket e sul web.</p>
<p>STOMP è progettato per interagire con un <span class="blue">broker di messaggi</span> realizzato in memoria (lato server);
dunque, rispetto all’uso delle WebSocket, rende più semplice inviare messaggi solo
a un particolare utente o ad utenti che sono iscritti a un particolare argomento.</p>
<section id="setup-e-dipendenze">
<h3><a class="toc-backref" href="#id15">Setup e Dipendenze</a><a class="headerlink" href="#setup-e-dipendenze" title="Permalink to this headline">¶</a></h3>
<p>Partendo dal SetUp precedente <a class="reference internal" href="#setupnostomp">SetupNoStomp</a>, aggiungiamo alcune dipendenze nel file <code class="docutils literal notranslate"><span class="pre">build.gradle</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dependencies</span> <span class="p">{</span>
<span class="o">//</span><span class="n">Dipendenze</span> <span class="n">generate</span> <span class="n">dal</span> <span class="n">Setup</span>
    <span class="n">implementation</span> <span class="s1">&#39;org.springframework.boot:spring-boot-starter-thymeleaf&#39;</span>
    <span class="n">implementation</span> <span class="s1">&#39;org.springframework.boot:spring-boot-starter-web&#39;</span>
    <span class="n">implementation</span> <span class="s1">&#39;org.springframework.boot:spring-boot-starter-websocket&#39;</span>
    <span class="n">developmentOnly</span> <span class="s1">&#39;org.springframework.boot:spring-boot-devtools&#39;</span>
    <span class="n">testImplementation</span> <span class="s1">&#39;org.springframework.boot:spring-boot-starter-test&#39;</span>

<span class="o">//</span><span class="n">Nuove</span> <span class="n">dipendenze</span>
<span class="n">implementation</span> <span class="s1">&#39;org.webjars:webjars-locator-core&#39;</span>
    <span class="n">implementation</span> <span class="s1">&#39;org.webjars:sockjs-client:1.5.1&#39;</span>
    <span class="n">implementation</span> <span class="s1">&#39;org.webjars:stomp-websocket:2.3.4&#39;</span>
<span class="n">implementation</span> <span class="s1">&#39;org.webjars:bootstrap:5.1.3&#39;</span>
<span class="n">implementation</span> <span class="s1">&#39;org.webjars:jquery:3.6.0&#39;</span>
</pre></div>
</div>
<p>I <span class="blue">WebJar</span> sono dipendenze lato client impacchettate in file JAR e non sono legate a Spring.
Per approfondire, si veda: <a class="reference external" href="https://www.baeldung.com/maven-webjars">https://www.baeldung.com/maven-webjars</a> e <a class="reference external" href="https://mvnrepository.com/artifact/org.webjars">https://mvnrepository.com/artifact/org.webjars</a>.</p>
</section>
<section id="websocket-vs-sockjs">
<h3><a class="toc-backref" href="#id16">WebSocket vs. SockJs</a><a class="headerlink" href="#websocket-vs-sockjs" title="Permalink to this headline">¶</a></h3>
<p>A partire dal 2018, il supporto WebSocket nei browser è quasi onnipresente.
Tuttavia, per supportare vecchi browwer, potrebbe essere necessario fare uso di
<a class="reference external" href="https://openbase.com/js/sockjs/documentation#what-is-sockjs">SockJS</a>, con le seguenti avvertenze:</p>
<ul class="simple">
<li><p>Le convenzioni del protocollo URL sono diverse per WebSocket ( <code class="docutils literal notranslate"><span class="pre">ws:/</span></code> o <code class="docutils literal notranslate"><span class="pre">wss:</span></code>) e SockJS ( <code class="docutils literal notranslate"><span class="pre">http:</span></code> o <code class="docutils literal notranslate"><span class="pre">https:</span></code>).</p></li>
<li><p>Le sequenze di handshake interne sono diverse, quindi alcuni broker utilizzeranno punti finali diversi per entrambi i protocolli.</p></li>
<li><p>Nessuno di questi consente di impostare intestazioni personalizzate durante l’handshake <em>HTTP</em>.</p></li>
<li><p><em>SockJS</em> supporta internamente diversi meccanismi di trasporto. Si potrebbe dover affrontare limitazioni
specifiche a seconda del trasporto effettivo in uso.</p></li>
<li><p>La riconnessione automatica non è abbastanza affidabile con <em>SockJS</em>.</p></li>
<li><p>Gli heartbeat potrebbero non essere supportati su <em>SockJS</em> da alcuni broker.</p></li>
<li><p><em>SockJS</em> non consente più di una connessione simultanea allo stesso broker.
Questo di solito non è un problema per la maggior parte delle applicazioni.</p></li>
</ul>
</section>
<section id="id1">
<h3><a class="toc-backref" href="#id17">Configurazione</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Il servizio viene configurato in SpringBoot da una classe che implementa l’interfaccia
<code class="docutils literal notranslate"><span class="pre">WebSocketMessageBrokerConfigurer</span></code> :</p>
<div class="highlight-Java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Configuration</span>
<span class="nd">@EnableWebSocketMessageBroker</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebSocketConfig</span>
         <span class="kd">implements</span> <span class="n">WebSocketMessageBrokerConfigurer</span><span class="p">{</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">configureMessageBroker</span><span class="p">(</span><span class="n">MessageBrokerRegistry</span> <span class="n">config</span><span class="p">){</span>
 <span class="n">config</span><span class="p">.</span><span class="na">enableSimpleBroker</span><span class="p">(</span><span class="s">&quot;/demoTopic&quot;</span><span class="p">);</span>
 <span class="n">config</span><span class="p">.</span><span class="na">setApplicationDestinationPrefixes</span><span class="p">(</span>
                <span class="s">&quot;/demoInput&quot;</span><span class="p">,</span><span class="s">&quot;/anotherInput&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerStompEndpoints</span><span class="p">(</span><span class="n">StompEndpointRegistry</span> <span class="n">registry</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">registry</span><span class="p">.</span><span class="na">addEndpoint</span><span class="p">(</span><span class="s">&quot;/unibo&quot;</span><span class="p">);</span>  <span class="c1">//.withSockJS();</span>
<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Nella configurazione specificata, il servizio:</p>
<ol class="arabic simple">
<li><p>abilita il supporto STOMP su <em>WebSocket</em> (escludiamo <em>SockJS</em>) registrando l’endpoint <code class="docutils literal notranslate"><span class="pre">unibo</span></code>.
Dunque l’indirizzo per connetersi sarà: <code class="docutils literal notranslate"><span class="pre">ws://&lt;serverIP&gt;:8080/unibo</span></code>;</p></li>
<li><p>abilita un broker su memoria comune, con prefisso di destinazione <code class="docutils literal notranslate"><span class="pre">demoTopic</span></code>. I client
si possono sottoscrivere a endpoint che iniziano con questo prefisso, ad es. <code class="docutils literal notranslate"><span class="pre">/demoTopic/output</span></code>;</p></li>
<li><p>imposta  <code class="docutils literal notranslate"><span class="pre">demoInput</span></code> e <code class="docutils literal notranslate"><span class="pre">anotherInput</span></code> come prefissi di destinazione dell’applicazione.
I clienti quindi invieranno messaggi agli endpoint che iniziano con <code class="docutils literal notranslate"><span class="pre">/demoInput/unibo</span></code> oppure
<code class="docutils literal notranslate"><span class="pre">/anotherInput/unibo</span></code>;</p></li>
</ol>
</section>
<section id="la-funzione-del-servizio">
<h3><a class="toc-backref" href="#id18">La funzione del servizio</a><a class="headerlink" href="#la-funzione-del-servizio" title="Permalink to this headline">¶</a></h3>
<p>Il servizio:</p>
<ol class="arabic simple">
<li><p>riceve un messaggio (in formato JSON) inviato su endpoint=``/unibo/input``;
il messaggio viene mappato in Java usando come DAO la classe <code class="docutils literal notranslate"><span class="pre">InputMessage</span></code></p></li>
<li><p>elabora il messaggio</p></li>
<li><p>costruisce un messaggio di risposta di tipo <code class="docutils literal notranslate"><span class="pre">OutputMessage</span></code> e lo pubblica
(ancora in formato JSON) sulla coda <code class="docutils literal notranslate"><span class="pre">/unibo/output</span></code>.</p></li>
</ol>
<p>La conversione dei messaggi da JSon a Java e viceversa è effettuata in modo automatico
in SpringBoot, una volta definito un opportuno controller.</p>
</section>
<section id="il-controller">
<h3><a class="toc-backref" href="#id19">Il controller</a><a class="headerlink" href="#il-controller" title="Permalink to this headline">¶</a></h3>
<p>Il controller specifica la gestione delle richieste <code class="docutils literal notranslate"><span class="pre">WebSocket</span></code> avviene in modo simile
alle normali richieste <code class="docutils literal notranslate"><span class="pre">HTTP</span></code>, ma utilizzando <code class="docutils literal notranslate"><span class="pre">&#64;SubscribeMappinge</span></code> o <code class="docutils literal notranslate"><span class="pre">&#64;MessageMapping</span></code>
(e non <code class="docutils literal notranslate"><span class="pre">&#64;RequestMapping</span></code> o <code class="docutils literal notranslate"><span class="pre">&#64;GetMapping</span></code>).</p>
<p>Nel caso specifico, utilizziamo <code class="docutils literal notranslate"><span class="pre">&#64;MessageMapping</span></code> per mappare i messaggi diretti a <code class="docutils literal notranslate"><span class="pre">input</span></code>.</p>
<p>L’annotazione <code class="docutils literal notranslate"><span class="pre">&#64;SendTo</span></code> indica che il valore di ritorno
deve essere inviato come messaggio alla destinazione specificata <code class="docutils literal notranslate"><span class="pre">/unibo/output</span></code>.</p>
<div class="highlight-Java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageController</span> <span class="p">{</span>

    <span class="nd">@MessageMapping</span><span class="p">(</span><span class="s">&quot;/input&quot;</span><span class="p">)</span>
    <span class="nd">@SendTo</span><span class="p">(</span><span class="s">&quot;/unibo/output&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">OutputMessage</span> <span class="nf">elabInput</span><span class="p">(</span><span class="n">InputMessage</span> <span class="n">msg</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">OutputMessage</span><span class="p">(</span><span class="s">&quot;Elaborated: &quot;</span>
      <span class="o">+</span> <span class="n">HtmlUtils</span><span class="p">.</span><span class="na">htmlEscape</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="na">getName</span><span class="p">())</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">entryMinimal</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="s">&quot;indexNoImages&quot;</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>L’operazione <code class="docutils literal notranslate"><span class="pre">HtmlUtils.htmlEscape</span></code> elabora il nome nel messaggio di input in modo da poter
essere reso nel DOM lato client.</p>
<p>Il file restituito dal controller è simile a quanto già introdotto nella versione non-SOMP</p>
</section>
<section id="componenti">
<h3><a class="toc-backref" href="#id20">Componenti</a><a class="headerlink" href="#componenti" title="Permalink to this headline">¶</a></h3>
<p>I componenti-base della applicazione in versione STOMP sono quindi oggetti DTO (<span class="blue">Data Transfer Object</span>)
rappresentati dalle classi <code class="docutils literal notranslate"><span class="pre">InputMessage</span></code> e <code class="docutils literal notranslate"><span class="pre">OutputMessage</span></code> .</p>
<table class="colwidths-given docutils align-default" style="width: 100%">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><div class="highlight-Java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InputMessage</span> <span class="p">{</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="p">;</span>
  <span class="kd">public</span> <span class="nf">InputMessage</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;}</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="n">name</span><span class="p">;}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;}</span>
<span class="p">}</span>
</pre></div>
</div>
</td>
<td><div class="highlight-Java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OutputMessage</span> <span class="p">{</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">content</span><span class="p">;</span>
<span class="kd">public</span> <span class="nf">OutputMessage</span><span class="p">(</span><span class="n">String</span> <span class="n">content</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="na">content</span> <span class="o">=</span> <span class="n">content</span><span class="p">;</span> <span class="p">}</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">getContent</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">content</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
<section id="index-html">
<h3><a class="toc-backref" href="#id21">index.html</a><a class="headerlink" href="#index-html" title="Permalink to this headline">¶</a></h3>
</section>
<section id="client-in-javascript-per-browser">
<h3><a class="toc-backref" href="#id22">Client (in javascript per browser)</a><a class="headerlink" href="#client-in-javascript-per-browser" title="Permalink to this headline">¶</a></h3>
<p>Parte relativa alla pagina:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span> <span class="nx">messageWindow</span>   <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;messageArea&quot;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">sendButton</span>      <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;send&quot;</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">messageInput</span>    <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;inputmessage&quot;</span><span class="p">);</span>

 <span class="nx">sendButton</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">sendMessage</span><span class="p">(</span><span class="nx">messageInput</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
    <span class="nx">messageInput</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
 <span class="p">};</span>

<span class="kd">function</span> <span class="nx">sendMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">stompClient</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;/unibo/inputmsg&quot;</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#inputmessage&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">()}));</span>
    <span class="nx">addMessageToWindow</span><span class="p">(</span><span class="s2">&quot;Sent Message: &quot;</span> <span class="o">+</span> <span class="nx">message</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">addMessageToWindow</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">messageWindow</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">+=</span> <span class="sb">`&lt;div&gt;</span><span class="si">${</span><span class="nx">message</span><span class="si">}</span><span class="sb">&lt;/div&gt;`</span>
<span class="p">}</span>

<span class="c1">//var socket =</span>
<span class="nx">connect</span><span class="p">();</span>
</pre></div>
</div>
<dl>
<dt>function connect() {</dt><dd><blockquote>
<div><p>//var socket  = new SockJS(‘/stomp-websocket’);
var host     = document.location.host;
//var pathname = document.location.pathname;
var addr     = “ws://” +host  + “/stomp-websocket”  ;
console.log(“connect addr=”+addr);</p>
<p>//var addr     = “ws://localhost/stomp-websocket”  ;</p>
</div></blockquote>
<p>var socket = new WebSocket(addr);</p>
<blockquote>
<div><dl class="simple">
<dt>socket.onopen = function (event) {</dt><dd><p>addMessageToWindow(“Connected”);</p>
</dd>
</dl>
<p>};</p>
<dl class="simple">
<dt>socket.onmessage = function (event) {</dt><dd><p>addMessageToWindow(<cite>Got Message: ${event.data}</cite>);
//alert(<cite>Got Message: ${event.data}</cite>)</p>
</dd>
</dl>
<p>};</p>
</div></blockquote>
<p>stompClient = Stomp.over(socket);
stompClient.connect({}, function (frame) {</p>
<blockquote>
<div><p>//setConnected(true);
addMessageToWindow(“Connected ” + frame);
//console.log(‘Connected: ‘ + frame);
stompClient.subscribe(‘/topic/output’, function (greeting) {</p>
<blockquote>
<div><p>showAnswer(JSON.parse(greeting.body).content);</p>
</div></blockquote>
<p>});</p>
</div></blockquote>
<p>});</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>function showAnswer(message) {</dt><dd><p>addMessageToWindow(“Answer:” + message);</p>
</dd>
</dl>
<p>}</p>
<p>Parte relativa alla interazione:</p>
</section>
<section id="client-in-java-per-programmi">
<h3><a class="toc-backref" href="#id23">Client (in Java per programmi)</a><a class="headerlink" href="#client-in-java-per-programmi" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://spring.io/guides/gs/messaging-stomp-websocket/">https://spring.io/guides/gs/messaging-stomp-websocket/</a></p>
<ul>
<li><p>Possibile premessa <a class="reference external" href="https://www.baeldung.com/intro-to-project-lombok">https://www.baeldung.com/intro-to-project-lombok</a></p></li>
<li></li>
<li></li>
<li><p>Create a Resource Representation Class. HelloMessage. Spring will use the Jackson JSON library to automatically marshal instances of type Greeting into JSON.</p></li>
<li><p>model the greeting representation, Greeting</p></li>
<li><p>Create a Message-handling Controller. GreetingController</p>
<div class="highlight-Java notranslate"><div class="highlight"><pre><span></span>    @MessageMapping(&quot;/hello&quot;)
  un msg inviato a /hello induce l&#39;esecuzione del metodo con input un oggetto di tipo HelloMessage
  ricavato dal payload del emssaggio
@SendTo(&quot;/topic/greetings&quot;)
  induce a inviare la risposta del metodo a tutti i sottoscrittori di /topic/greetings
</pre></div>
</div>
</li>
<li><p>Configure Spring for STOMP messaging. WebSocketConfig</p></li>
<li><div class="highlight-Java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Configuration</span>
<span class="nd">@EnableWebSocketMessageBroker</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebSocketConfig</span> <span class="kd">implements</span> <span class="n">WebSocketMessageBrokerConfigurer</span> <span class="p">{</span>
</pre></div>
</div>
</li>
<li><p>Create a Browser Client . index.html</p></li>
<li><p>./gradlew bootRun</p></li>
<li><p>java -jar build/libs/gs-messaging-stomp-websocket-0.1.0.jar</p></li>
</ul>
<p><a class="reference external" href="https://www.baeldung.com/websockets-spring">https://www.baeldung.com/websockets-spring</a></p>
<p><a class="reference external" href="https://www.dariawan.com/series/build-spring-websocket-application/">https://www.dariawan.com/series/build-spring-websocket-application/</a></p>
<p><a class="reference external" href="https://www.dariawan.com/tutorials/spring/spring-boot-websocket-basic-example/">https://www.dariawan.com/tutorials/spring/spring-boot-websocket-basic-example/</a></p>
</section>
<section id="esempio-piu-articolato">
<h3><a class="toc-backref" href="#id24">Esempio più articolato</a><a class="headerlink" href="#esempio-piu-articolato" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://www.dariawan.com/tutorials/spring/build-chat-application-using-spring-boot-and-websocket/">https://www.dariawan.com/tutorials/spring/build-chat-application-using-spring-boot-and-websocket/</a></p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">websocket</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Web sockets</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#websocket-in-springboot-versione-base">WebSocket in SpringBoot: versione base</a></li>
<li class="toctree-l2"><a class="reference internal" href="#websocket-in-springboot-versione-stomp">WebSocket in SpringBoot: versione STOMP</a></li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter">Welcome to websocket’s documentation!</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Antonio Natali.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/WebSockets.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>